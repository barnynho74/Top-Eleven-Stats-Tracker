<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="TEicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top Eleven Stats Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <style>
        :root {
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
            --gk-color:#add8e6;
            --def-color:#90ee90;
            --mid-color:#ffff99;
            --att-color:#ff9999;
        }
        body{font-family:Arial,sans-serif;margin:0;padding:0;background-color:#f5f5f5;}
        .top-bar{display:flex;background-color:#333;color:#fff;height: 60px;align-items:center; }
        .tab{flex:1;text-align:center;padding:21px;cursor:pointer;transition:background-color .3s;}
        .tab:hover{background-color:#555;}
        .tab.active{background-color:#007bff;font-weight:bold;}
        .content{padding:20px;display:none;}
        .content.active{display:block;}
        .player-list{display:flex;flex-direction:column;gap:8px;}
        .player-card{background-color:#fff;border-radius:5px;padding:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);display:flex;align-items:center;justify-content:space-between;font-size:13px;}
        .player-info{flex-grow:1;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
        .position-label{padding:2px 6px;border-radius:3px;font-weight:bold;font-size:11px;color:#000;}
        .gk{background-color:var(--gk-color);} .def{background-color:var(--def-color);} .mid{background-color:var(--mid-color);} .att{background-color:var(--att-color);}
        .weeks-container{display:flex;flex-direction:row;margin-left:15px;}
        .week-header{display:block;align-items:center;margin-bottom:5px;}
        .week-label{font-weight:bold;font-size:12px;margin-right:10px;min-width:60px;color:#333;}
        .days-header{display:flex;font-size:11px;}
        .day-cell{width:25px;text-align:center;font-size:11px;border:1px solid #ddd;padding:1px;}
        .player-days{display:flex;}
        .player-day-input{width:25px;height:18px;text-align:center;border:1px solid #ddd;padding:1px;font-size:11px;}
.day-average{width:25px;text-align:center;font-size:9px;color:#666;height:18px;line-height:18px;border:1px solid transparent;padding:1px;box-sizing:content-box;}
        .week-divider{border-left:2px solid #007bff;margin:0 5px;height:20px;}
        .add-player-btn{background-color:#28a745;color:#fff;border:none;border-radius:50%;width:30px;height:30px;font-size:20px;cursor:pointer;margin:10px 0;display:flex;align-items:center;justify-content:center;}
        .squad-average{font-weight:bold;margin:0 0 10px 5px;}
        .modal,.confirm-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:100;justify-content:center;align-items:center;}
        .modal-content,.confirm-content{background-color:#fff;padding:20px;border-radius:5px;width:320px;max-height:80vh;overflow-y:auto;}
        .form-group{margin-bottom:15px;} .form-group label{display:block;margin-bottom:5px;font-weight:bold;}
        .form-group input,.form-group select{width:100%;padding:8px;box-sizing:border-box;border:1px solid #ddd;border-radius:3px;}
        .modal-buttons{display:flex;justify-content:flex-end;gap:10px;}
        .modal-buttons button{padding:8px 15px;border:none;border-radius:3px;cursor:pointer;}
        .save-btn{background-color:#28a745;color:#fff;} .cancel-btn{background-color:#dc3545;color:#fff;}
        .edit-btn{background-color:#ffc107;color:#000;border-radius:3px;padding:4px 8px;font-size:11px;}
        .delete-btn{background-color:#dc3545;color:#fff;border-radius:3px;padding:4px 8px;font-size:11px;}
        .favorite-star{font-size:18px;cursor:pointer;color:#ccc;transition:color .2s;}
        .favorite-star.favorited{color:#ffc107;}
        .card-tags-container{display:flex;gap:4px;margin-left:8px;}
        .card-tag{width:16px;height:16px;border-radius:50%;cursor:pointer;border:1px solid #ccc;background-color:#f0f0f0;transition:all .2s;font-size:10px;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#aaa;}
        .card-tag.active{color:white;}
        #minutes-content table, #goals-assists-content table{width:100%;border-collapse:collapse;margin-top:20px;font-size:13px;}
        #minutes-content th,#goals-assists-content th,#minutes-content td,#goals-assists-content td{border:1px solid #ddd;padding:6px;text-align:left;}
        #minutes-content th,#goals-assists-content th{background-color:#f2f2f2;}
        .bottom-actions{margin-top:15px;display:flex;justify-content:flex-end;}
        .age-all-btn{background-color:#17a2b8;color:#fff;border:none;border-radius:4px;padding:8px 15px;font-size:13px;cursor:pointer;}
        .end-season-btn{background-color:#c82333;color:#fff;border:none;border-radius:4px;padding:8px 15px;font-size:13px;cursor:pointer;margin-left:10px;}
        .minutes-controls{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;}
        .full-match-btn{background-color:#28a745;color:#fff;border:none;border-radius:4px;padding:8px 15px;cursor:pointer;}
        .minutes-input{width:60px;padding:8px;border:1px solid #ddd;border-radius:4px;}
        .confirm-minutes-btn{background-color:#007bff;color:#fff;border:none;border-radius:4px;padding:8px 15px;cursor:pointer;}
        .reset-minutes-btn{background-color:#dc3545;color:#fff;border:none;border-radius:4px;padding:4px 8px;font-size:11px;cursor:pointer;}
        .reset-player-minutes-btn{background-color:#ffc107;color:#000;border:none;border-radius:3px;padding:2px 6px;font-size:10px;cursor:pointer;}
        .minutes-form{margin-top:20px;padding:15px;background-color:#f8f9fa;border-radius:5px;}
        .star-rating{position:relative;display:inline-block;font-size:14px;line-height:1;}
        .star-rating .stars-outer{color:#ccc;} .star-rating .stars-inner{position:absolute;top:0;left:0;white-space:nowrap;overflow:hidden;color:#f5b301;}
        /* Resizable container for GA table */
        .table-container{resize:both;overflow:auto;max-width:100%;border:1px solid #ccc;padding-bottom:4px;}
        .ga-control{display:flex;align-items:center;justify-content:center;gap:5px;}
        .ga-btn{background-color:#007bff;color:white;border:none;border-radius:50%;width:22px;height:22px;font-size:16px;font-weight:bold;cursor:pointer;line-height:22px;padding:0;}
        .ga-btn.minus{background-color:#6c757d;}
        .ga-value{font-weight:bold;font-size:14px;min-width:20px;text-align:center;}
        
        /* Competition colors */
        .league-header{background-color:#ffebee !important;color:#c62828;}
        .cl-header{background-color:#e3f2fd !important;color:#1565c0;}
        .cup-header{background-color:#e8f5e8 !important;color:#2e7d32;}
        
        /* Section separators */
        .stats-separator{border-left:3px solid #333 !important;}
        .per90-separator{border-left:3px solid #666 !important;}
        .league-color { color: #c62828; font-weight: bold; }
        .cl-color { color: #1565c0; font-weight: bold; }
        .cup-color { color: #2e7d32; font-weight: bold; }
        
        /* Enhanced table styling */
        #goals-assists-table th{
            font-weight:bold;
            font-size:12px;
        }
        #goals-assists-table .competition-section{
            position:relative;
        }
        
        /* Player name styling */
        .player-name-bold {
            font-weight: bold;
        }
        
        /* Player name styling */
        #minutes-table tbody tr.selected {
            background-color: #d1ecf1 !important; /* A light blue for selection */
            outline-style: dashed;
        }
        #power-ranking-table tbody tr.selected {
            background-color: #d1ecf1 !important;
            font-weight: bold;
        }
        .training-calculator{background:#fff;border:1px solid #e9e9e9;border-radius:8px;padding:15px;margin-bottom:20px;max-width:400px;box-shadow:0 2px 4px rgba(0,0,0,.05);}
        .training-calculator h3{margin-top:0;text-align:center;font-size:16px;color:#333;}
        #training-table{width:100%;border-collapse:collapse;margin-bottom:10px;}
        #training-table td{padding:6px;border:1px solid #ddd;font-size:13px;}
        #training-table td:first-child{font-weight:bold;color:#555;}
        .training-input{width:100%;box-sizing:border-box;text-align:center;border:1px solid #ccc;border-radius:3px;padding:4px;}
        .training-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        .reset-training-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
        }
        .edit-training-times-btn {
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
        }
        .training-time-input {
            width: 60px;
            font-size: 13px;
            padding: 4px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .jump-to-tab {
    color: #d9534f; /* blago crvena nijansa koja se slaže s upozorenjem */
    font-weight: bold;
    text-decoration: none; /* makni klasično podcrtavanje */
    cursor: pointer;
    transition: color 0.2s ease, text-shadow 0.2s ease;
}

.jump-to-tab:hover {
    text-decoration: underline;
    color: #c9302c; /* tamnija crvena kad pređeš mišem */
    text-shadow: 0 0 3px rgba(217, 83, 79, 0.4); /* lagani sjaj */
}

.jump-to-tab:active {
    color: #a94442; /* još tamnija kad se klikne */
}

        .note-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;}
        .note-tag-btn{background-color:#f0f0f0;color:#333;border:1px solid #ccc;border-radius:12px;padding:3px 10px;font-size:11px;cursor:pointer;transition:all .2s;}
        .note-tag-btn.active{font-weight:bold;}
        .data-io-buttons{margin-bottom:15px;display:flex;gap:10px;}
.data-io-buttons button{background-color:#6c757d;color:white;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:13px;}
#most-improved-table th { cursor: pointer; user-select: none; }
#most-improved-table th:hover { background-color: #e9ecef; }
#most-improved-table th .sort-indicator {
    display: inline-block;
    margin-left: 5px;
    opacity: 0.5;
    transition: opacity 0.2s, transform 0.2s;
}
#most-improved-table th .sort-indicator.asc { opacity: 1; transform: rotate(180deg); }
#most-improved-table th .sort-indicator.desc { opacity: 1; transform: rotate(0deg); }
.chart-container {
            margin-top: 25px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
            border: 1px solid #e9e9e9;
        }
        .chart-container h3 {
            margin-top: 0;
            text-align: center;
            font-size: 16px;
            color: #333;
        }
        #power-ranking-layout {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: stretch;
        }
        #power-ranking-table-container {
            flex: 1 1 auto;
        }
        #power-ranking-chart-container {
            flex: 1 1 auto;
            position: relative;
            top: 0;
            width: 100%;
            margin-top: 20px;
            height: 500px; /* Restrict height */
        }
        .chart-zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 10;
        }
        .chart-zoom-btn {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.7);
            border-radius: 4px;
            width: 30px;
            height: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .chart-zoom-btn:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }
        /* Tab with dropdown */
        .tab-container {
            position: relative;
            flex: 1;
        }
        .tab-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #444;
            z-index: 101;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .tab-container:hover .tab-dropdown {
            display: block;
        }
        .dropdown-item {
            padding: 12px 20px;
            text-align: center;
            cursor: pointer;
            transition: background-color .3s;
            color: #fff;
            font-size: 14px;
        }
        .dropdown-item:hover {
            background-color: #555;
        }
/* Add style for new archive button */
        .archive-btn{
            background-color:#28a745;
            color:#fff;
            border-radius:3px;
            border: 2px solid black;
            padding:4px 8px;
            font-size:11px;
            cursor:pointer;
        }
        /* Archive tab styling */
        #archived-players-content .player-card {
            opacity: 0.8;
            
        }
        #archived-players-content .player-card .archive-btn {
            display: none;
        }
        .top-score {
            background-color: #d4edda;
            color: #155724;
            font-weight: bold;
        }
        /* Hall of Fame styles */
        #hall-of-fame-layout {
            display: flex;
            gap: 20px;
        }
        #hof-sidebar {
            width: 200px;
            flex-shrink: 0;
        }
        #hof-sidebar h3 { margin-top: 0; }
        .hof-category-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .hof-category-btn:hover {
            background-color: #e9ecef;
            border-color: #ccc;
        }
        .hof-category-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            font-weight: bold;
        }
        #hof-content {
            flex-grow: 1;
        }
        #hof-content h2 { margin-top: 0; }
        #hof-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        #hof-table th, #hof-table td {
            border: 1px solid #ddd;
            padding: 4px 8px;
            text-align: left;
        }
        #hof-table th {
            background-color: #f2f2f2;
            font-size: 12px;
        }
        #hof-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        #hof-table .rank {
            font-weight: bold;
            text-align: center;
            width: 40px;
        }
        #hof-table .value {
            font-weight: bold;
            text-align: right;
            width: 100px;
        }
        #hof-table .player-name {
            font-weight: 500;
        }
        .formula-explanation {
            margin-top: 25px;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #e9e9e9;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,.05);
            font-size: 14px;
            line-height: 1.6;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
        }
        .formula-explanation h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .formula-explanation .formula {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            white-space: pre-wrap;
            color: #333;
            border: 1px solid #e9ecef;
        }
        .formula-explanation h4 {
            font-size: 15px;
            color: #007bff;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .formula-explanation ul {
            list-style-type: none;
            padding-left: 15px;
        }
        .formula-explanation li {
            margin-bottom: 8px;
        }
        .formula-explanation code {
            background-color: #e9ecef;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }
        /* Side Panel Calculator Styles */
        .stats-calculator-panel {
            position: fixed;
            right: -320px;
            top: 50%;
            transform: translateY(-50%);
            width: 320px;
            background-color: #fff;
            box-shadow: -2px 0 10px rgba(0,0,0,0.2);
            border-radius: 8px 0 0 8px;
            transition: right 0.3s ease;
            z-index: 999;
            padding: 0px;
        }
        .stats-calculator-panel.open {
            right: 0;
        }
        .calculator-toggle {
            position: absolute;
            left: -35px;
            top: 50%;
            transform: translateY(-50%);
            width: 35px;
            height: 80px;
            background-color: #007bff;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            transition: background-color 0.3s;
        }
        .calculator-toggle:hover {
            background-color: #0056b3;
        }
        .calculator-toggle .arrow {
            transition: transform 0.3s;
        }
        .stats-calculator-panel.open .calculator-toggle .arrow {
            transform: rotate(180deg);
        }
        .stats-calculator-content h3 {
            margin-top: 0;
            font-size: 16px;
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .stats-calc-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        .stats-calc-table th {
            background-color: #f2f2f2;
            padding: 6px 4px;
            font-size: 12px;
            border: 1px solid #ddd;
            font-weight: bold;
        }
        .stats-calc-table td {
            padding: 4px;
            border: 1px solid #ddd;
        }
        .stats-calc-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 12px;
            text-align: center;
        }
        .stats-calc-sum {
            font-weight: bold;
            text-align: center;
            background-color: #e9ecef;
            padding: 6px;
            font-size: 13px;
        }
        .calc-reset-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            width: 100%;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
        }
        .calc-reset-btn:hover {
            background-color: #c82333;
        }
        .archived-pr-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }
        .archived-pr-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .archived-pr-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            background: none;
            border: none;
        }
        .archived-pr-close:hover {
            color: #333;
        }
        .view-pr-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            font-size: 13px;
            cursor: pointer;
            margin-left: 10px;
        }
        .view-pr-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <!-- Stats Calculator Side Panel -->
    <div class="stats-calculator-panel" id="stats-calculator">
        <div class="calculator-toggle" id="calc-toggle">
            <span class="arrow">◄</span>
        </div>
        <div class="stats-calculator-content">
            <h3>Quick Stats Calculator</h3>
            <table class="stats-calc-table">
                <thead>
                    <tr>
                        <th>Minutes</th>
                        <th>Matches</th>
                        <th>Goals</th>
                        <th>Assists</th>
                    </tr>
                </thead>
                <tbody id="calc-table-body">
                    <!-- Rows will be generated by JavaScript -->
                </tbody>
                <tfoot>
                    <tr>
                        <td class="stats-calc-sum" id="calc-sum-minutes">0</td>
                        <td class="stats-calc-sum" id="calc-sum-matches">0</td>
                        <td class="stats-calc-sum" id="calc-sum-goals">0</td>
                        <td class="stats-calc-sum" id="calc-sum-assists">0</td>
                    </tr>
                </tfoot>
            </table>
            <button class="calc-reset-btn" id="calc-reset-btn">Clear All</button>
        </div>
    </div>
    <div class="top-bar">
        <div class="tab active" data-tab="progress">PROGRESS</div>
        <div class="tab" data-tab="minutes">MINUTES</div>
        <div class="tab" data-tab="goals-assists">GOALS & ASSISTS</div>
        <div class="tab" data-tab="most-improved">MOST IMPROVED</div>
        <div class="tab" data-tab="power-ranking">POWER RANKING</div>
        <div class="tab-container">
            <div class="tab" data-tab="archived-players">ARCHIVED PLAYERS</div>
            <div class="tab-dropdown">
                <div class="dropdown-item" data-tab="hall-of-fame">HALL OF FAME</div>
            </div>
        </div>
    </div>
    <div id="progress-content" class="content active">
        <button class="add-player-btn" id="add-player-btn">+</button>
        <div class="squad-average">
            Average quality: <span id="avg-quality">--</span>%<br>
            Squad size: <span id="squad-count">0</span> players<br>
            Average age: <span id="avg-age">--</span>
        </div>
        <div style="margin-bottom: 15px;">
            <label for="sort-option" style="margin-right: 10px; font-weight: bold;">Sort by:</label>
            <select id="sort-option" style="padding: 5px; border-radius: 4px; border: 1px solid #ddd;">
                <option value="position">Position</option>
                <option value="quality">Current Quality</option>
            </select>
        </div>
        <div class="player-list" id="player-list"></div>
        <div class="bottom-actions"><button class="age-all-btn" id="age-all-btn">+1 Year to All Players</button><button class="end-season-btn" id="end-season-btn">End Season & Archive</button></div>
        <hr style="margin: 20px 0;">
        <div id="archive-section">
            <h2>Season Archives & Data Management</h2>
            <div class="data-io-buttons">
                <button id="download-data-btn">Download All Data</button>
                <button id="upload-data-btn">Upload Data File</button>
                <input type="file" id="upload-file-input" style="display:none;" accept=".json">
            </div>
            <p style="font-size: 12px; color: #666; margin-top: -5px; max-width: 350px;">
                Download a single JSON file containing all current players, archived seasons, and settings. Uploading will overwrite all existing data.
            </p>
            <div id="player-search-section" style="margin-top: 20px; margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 5px;">
                <h4 style="margin-top: 0; margin-bottom: 10px; font-size: 15px;">Search Player History</h4>
                <input type="search" id="player-search-input" placeholder="Enter player name to search archives..." style="width: 100%; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ddd;">
                <div id="player-search-results" style="margin-top: 15px;"></div>
            </div>
            <div id="archive-list">
                <p>No archived seasons yet.</p>
            </div>
        </div>
    </div>
    <div id="minutes-content" class="content">
        <h2>Minutes</h2>
        <div class="minutes-form">
            <h3>Add Minutes for Current Match</h3>
            <div class="minutes-controls">
                <button class="full-match-btn" id="full-match-btn">Full Match (90 min)</button>
                <input type="number" class="minutes-input" id="minutes-input" placeholder="Minutes" min="1" max="90">
                <button class="confirm-minutes-btn" id="confirm-minutes-btn">Confirm</button>
                <button class="reset-minutes-btn" id="undo-minutes-btn">Undo Last Change</button>
            </div>
        </div>
        <table id="minutes-table">
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Positions</th>
                    <th>Age</th>
                    <th>Quality</th>
                    <th>Total Minutes</th>
                    <th>Matches</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
   <div id="goals-assists-content" class="content">
        <h2>Goals & Assists</h2>
        <div class="minutes-form">
            <button class="reset-minutes-btn" id="undo-ga-btn">Undo Last Change</button>
        </div>
        <div class="table-container">
        <table id="goals-assists-table">
            <thead>
                <tr>
                    <th rowspan="2">Player</th>
                    <th rowspan="2">Positions</th>
                    <th rowspan="2">Age</th>
                    <th rowspan="2">Current Quality</th>
                    <th colspan="2" class="league-header">League</th>
                    <th colspan="2" class="cl-header">Champ. League</th>
                    <th colspan="2" class="cup-header">Cup</th>
                    <th rowspan="2" class="stats-separator">Total G</th>
                    <th rowspan="2">Total A</th>
                    <th rowspan="2">G+A</th>
                    <th rowspan="2" class="per90-separator">G/90min</th>
                    <th rowspan="2">A/90min</th>
                    <th rowspan="2">G+A/90min</th>
                </tr>
                <tr>
                    <th class="league-header">G</th><th class="league-header">A</th>
                    <th class="cl-header">G</th><th class="cl-header">A</th>
                    <th class="cup-header">G</th><th class="cup-header">A</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        </div>
    </div>
    <div id="most-improved-content" class="content">
        <h2>Most Improved Players</h2>
        <div class="table-container">
            <table id="most-improved-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th data-sort="player">Player <span class="sort-indicator">▼</span></th>
                        <th>Positions</th>
                        <th data-sort="age">Age <span class="sort-indicator">▼</span></th>
                        <th data-sort="initialQuality">Initial Quality <span class="sort-indicator">▼</span></th>
                        <th data-sort="currentQuality">Current Quality <span class="sort-indicator">▼</span></th>
                        <th data-sort="minutes">Minutes <span class="sort-indicator">▼</span></th>
                        <th data-sort="matches">Matches <span class="sort-indicator">▼</span></th>
                        <th data-sort="avgMinPerMatch">Avg Min/90 <span class="sort-indicator">▼</span></th>
                        <th data-sort="g">G <span class="sort-indicator">▼</span></th>
                        <th data-sort="a">A <span class="sort-indicator">▼</span></th>
                        <th data-sort="improvement" data-order="desc">Improvement <span class="sort-indicator desc">▼</span></th>
                        <th data-sort="improvementPercent">Improvement % <span class="sort-indicator">▼</span></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="chart-container">
            <h3>Talent Identification: Age vs. Improvement (Size = Minutes)</h3>
            <canvas id="talent-chart"></canvas>
        </div>
        <div class="training-calculator">
            <h3>Training Bonus Calculator</h3>
            <table id="training-table">
                <tbody></tbody>
            </table>
            <div class="training-actions">
                <div class="training-summary">
                    <p>Player fatigue must be between: <span id="training-range"></span></p>
                </div>
                <div>
                    <button class="edit-training-times-btn" id="edit-training-times-btn">Edit Times</button>
                    <button class="reset-training-btn" id="reset-training-btn">Reset Bonuses</button>
                </div>
            </div>
        </div>
    </div>
    </div>
    <div id="power-ranking-content" class="content">
        <h2>Player Power Ranking</h2>
        <div class="minutes-form" style="margin-bottom: 20px;">
            <button class="confirm-minutes-btn" id="update-power-ranking-btn">UPDATE POWER RANKING</button>
            <p style="font-size: 12px; color: #666; margin-top: 8px; max-width: 600px; color:red">
                Before hitting the UPDATE button, do the following: <br>1. Enter all minutes played in the <a href="#" class="jump-to-tab" data-tab="minutes">MINUTES</a> tab.<br>2. Enter ALL GOALS and ASSISTS in the <a href="#" class="jump-to-tab" data-tab="goals-assists">GOALS & ASSISTS</a> tab.<br>3. Ensure player qualities are up to date in the <a href="#" class="jump-to-tab" data-tab="progress">PROGRESS</a> tab.<br>
            </p>
        </div>
        <div id="power-ranking-layout">
            <div class="table-container" id="power-ranking-table-container">
                <table id="power-ranking-table">
                    <thead>
                        <tr>
                            <th data-sort="rank">Rank</th>
                            <th data-sort="player">Player</th>
                            <th>Positions</th>
                            <th data-sort="change">+/-</th>
                            <th data-sort="powerScore" data-order="desc">Power Score ▼</th>
                            <th data-sort="currentQuality">Quality</th>
                            <th data-sort="improvementScore">Improvement</th>
                            <th data-sort="adjustedGaPer90">G+A Score</th>
                            <th data-sort="usageScore">Usage</th>
                            <th data-sort="ageValue">Age Bonus</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="power-ranking-chart-container" class="chart-container">
                 <h3>Power Ranking History</h3>
                 <div class="chart-zoom-controls">
                    <button class="chart-zoom-btn" id="zoom-in-btn">+</button>
                    <button class="chart-zoom-btn" id="zoom-out-btn">-</button>
                    <button class="chart-zoom-btn" id="reset-zoom-btn" style="font-size: 14px;">⟲</button>
                 </div>
                 <canvas id="power-ranking-chart"></canvas>
            </div>
        </div>
        <p style="text-align: center; font-size: 12px; color: #666; margin-top: 10px;">
            <br><b>Tip:</b> Hold <kbd>CTRL</kbd> and scroll to zoom, or use the +/- buttons. Click and drag to pan.
        </p>
        <div class="formula-explanation">
            <h3>How the Power Score is Calculated</h3>
            <div class="formula">
PowerScore = (QualityScore) + (ImprovementScore) + (G+A_Score) + (UsageScore) + (AgeBonus)
            </div>
            <h4>1. Quality Score</h4>
            <p>Calculates a player's value based on their current quality percentage using a cubic polynomial curve. This rewards higher-quality players exponentially, reflecting their on-pitch dominance.</p>
            <div class="formula">f(x) = 0.0001758x³ - 0.05093x² + 4.9956x - 156.47</div>
            <h4>2. Improvement Score</h4>
            <p>Assigns points based on the total quality improvement since the start of the season. This score is mapped to specific thresholds, rewarding significant progress.</p>
             <ul>
                <li><strong>+1-4% Increase:</strong> 0 points</li>
                <li><strong>+5-6% Increase:</strong> 1 point</li>
                <li><strong>+7-10% Increase:</strong> 2 points</li>
                 <li>...and so on, up to 20 points for a 30% increase.</li>
            </ul>
            <h4>3. G+A Score</h4>
            <p>Calculates a player's raw goal and assist output, weighted heavily by their position on the pitch to reward contributions from less offensive roles.</p>
            <ul>
                <li><strong>Forwards (ST, AML, AMC, AMR):</strong> <code>Goal = 1.1</code>, <code>Assist = 0.8</code></li>
                <li><strong>Midfielders (MC, ML, MR, DMC):</strong> <code>Goal = 1.8</code>, <code>Assist = 1.5</code></li>
                <li><strong>Defenders (DC, DL, DR, GK):</strong> <code>Goal = 2.7</code>, <code>Assist = 2.3</code></li>
            </ul>
            <h4>4. Usage Score</h4>
            <p>Measures a player's direct goal involvement per 90 minutes and scales it up. This emphasizes players who are efficient with their time on the pitch.</p>
            <div class="formula">UsageScore = (G+A per 90 minutes) × 3</div>
            <h4>5. Age Bonus</h4>
            <p>A small bonus awarded to younger players, reflecting their potential and future value.</p>
            <ul>
                <li><strong>18–21 years:</strong> +5 points</li>
                <li><strong>22–25 years:</strong> +3 points</li>
                <li><strong>26+ years:</strong> +2 points</li>
            </ul>
        </div>
    </div>
    
    <div id="archived-players-content" class="content">
        <h2>Archived Players</h2>
        <div class="minutes-form" id="archive-filters" style="margin-bottom: 20px;">
            <h3 style="margin: 0 0 10px 0; font-size: 16px;">Filter Archived Players</h3>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                <select id="archive-position-filter" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                    <option value="all">All Positions</option>
                    <option value="gk">Goalkeepers</option>
                    <option value="def">Defenders</option>
                    <option value="mid">Midfielders</option>
                    <option value="att">Strikers</option>
                </select>
                <input type="number" id="archive-age-filter-min" placeholder="Min Age" class="minutes-input">
                <input type="number" id="archive-age-filter-max" placeholder="Max Age" class="minutes-input">
                <input type="number" id="archive-minutes-filter-min" placeholder="Min Mins" class="minutes-input">
                <input type="number" id="archive-minutes-filter-max" placeholder="Max Mins" class="minutes-input">
                <input type="number" id="archive-matches-filter-min" placeholder="Min Matches" class="minutes-input">
                <input type="number" id="archive-matches-filter-max" placeholder="Max Matches" class="minutes-input">
                <input type="number" id="archive-goals-filter-min" placeholder="Min Goals" class="minutes-input">
                <input type="number" id="archive-goals-filter-max" placeholder="Max Goals" class="minutes-input">
                <input type="number" id="archive-assists-filter-min" placeholder="Min Assists" class="minutes-input">
                <input type="number" id="archive-assists-filter-max" placeholder="Max Assists" class="minutes-input">
                <button class="reset-minutes-btn" id="reset-archive-filters-btn">Reset Filters</button>
            </div>
        </div>
        <div class="table-container">
            <table id="archived-players-table">
                <thead>
                    <tr>
                        <th data-sort="name">Player <span class="sort-indicator">▼</span></th>
                        <th>Positions</th>
                        <th data-sort="age">Age <span class="sort-indicator">▼</span></th>
                        <th data-sort="minutes">Minutes <span class="sort-indicator">▼</span></th>
                        <th data-sort="matches">Matches <span class="sort-indicator">▼</span></th>
                        <th data-sort="avgMinPerMatch">Avg Min/Match <span class="sort-indicator">▼</span></th>
                        <th data-sort="goals">Goals <span class="sort-indicator">▼</span></th>
                        <th data-sort="assists">Assists <span class="sort-indicator">▼</span></th>
                        <th data-sort="gaPer90">G+A/90 <span class="sort-indicator">▼</span></th>
                        <th data-sort="archiveReason">Reason</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <div id="hall-of-fame-content" class="content">
        <div id="hall-of-fame-layout">
            <div id="hof-sidebar">
                <h3>Categories</h3>
                <button class="hof-category-btn active" data-category="matchesPlayed">Matches Played</button>
                <button class="hof-category-btn" data-category="totalMinutes">Total Minutes</button>
                <button class="hof-category-btn" data-category="goals">Total Goals</button>
                <button class="hof-category-btn" data-category="assists">Total Assists</button>
                <button class="hof-category-btn" data-category="gaPer90">G+A per 90</button>
            </div>
            <div id="hof-content">
                <h2 id="hof-title">Hall of Fame: Top 10 by Matches Played</h2>
                <div class="table-container">
                    <table id="hof-table">
                        <thead>
                            <tr>
                                <th class="rank">Rank</th>
                                <th class="player-name">Player</th>
                                <th>Positions</th>
                                <th>Age</th>
                                <th>Seasons Played</th>
                                <th class="value" id="hof-value-header">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Content will be generated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Player modal -->
    <div class="modal" id="player-modal">
        <div class="modal-content">
            <h2 id="modal-title">Add New Player</h2>
            <div class="form-group">
                <label for="player-name">Player Name:</label>
                <input type="text" id="player-name" required>
            </div>
            <div class="form-group">
                <label for="player-position">Position(s): <small>(Ctrl/Cmd + click for multiple, max 3)</small></label>
                <select id="player-position" multiple size="13" required>
                    <!--GK-->
                    <option value="GK">GK (Goalkeeper)</option>
                    <optgroup label="Defense">
                        <option value="DL">DL (Left Defender)</option>
                        <option value="DC">DC (Center Defender)</option>
                        <option value="DR">DR (Right Defender)</option>
                    </optgroup>
                    <optgroup label="Midfield">
                        <option value="DMC">DMC (Defensive Midfielder)</option>
                        <option value="ML">ML (Left Midfielder)</option>
                        <option value="MC">MC (Center Midfielder)</option>
                        <option value="MR">MR (Right Midfielder)</option>
                        <option value="AML">AML (Attacking Midfielder Left)</option>
                        <option value="AMC">AMC (Attacking Midfielder Center)</option>
                        <option value="AMR">AMR (Attacking Midfielder Right)</option>
                    </optgroup>
                    <optgroup label="Attack">
                        <option value="ST">ST (Striker)</option>
                    </optgroup>
                </select>
            </div>
            <div class="form-group">
                <label for="player-age">Age:</label>
                <input type="number" id="player-age" min="16" max="45" required>
            </div>
            <div class="form-group">
                <label for="player-quality">Quality (%):</label>
                <input type="number" id="player-quality" min="1" max="100" required>
            </div>
            <div class="modal-buttons">
                <button class="cancel-btn" id="cancel-btn">Cancel</button>
                <button class="save-btn" id="save-btn">Save</button>
            </div>
        </div>
    </div>
    
    <div class="confirm-modal" id="confirm-modal">
        <div class="confirm-content">
            <h3>Delete Player</h3>
            <p>Are you sure you want to delete this player?</p>
            <p id="player-to-delete"></p>
            <div class="confirm-buttons">
                <button class="cancel-btn" id="confirm-cancel">Cancel</button>
                <button class="save-btn" id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>
    <!-- Archived Power Ranking Modal -->
    <div class="archived-pr-modal" id="archived-pr-modal">
        <div class="archived-pr-content">
            <button class="archived-pr-close" id="archived-pr-close">&times;</button>
            <h2 id="archived-pr-title">Season Power Rankings</h2>
            <div id="archived-pr-body">
                <!-- Content will be dynamically generated -->
            </div>
        </div>
    </div>
<script>
    document.addEventListener('DOMContentLoaded',function(){
        /* Tabs */
        document.querySelectorAll('.jump-to-tab').forEach(link => {
    link.addEventListener('click', e => {
        e.preventDefault();
        const tabName = link.dataset.tab;

        // pronađi i klikni pravi tab
        const targetTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
        if (targetTab) {
            targetTab.click(); // simulira klik — aktivira tab
        }
    });
});

        const tabs=document.querySelectorAll('.tab, .dropdown-item');
        tabs.forEach(tab=>{tab.addEventListener('click',function(){
            // Handle active state for main tabs only
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if (this.classList.contains('tab')) {
                this.classList.add('active');
            } else {
                // If a dropdown item is clicked, also activate its parent tab
                this.closest('.tab-container').querySelector('.tab').classList.add('active');
            }
            
            const tabName=this.dataset.tab;
            document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
            document.getElementById(`${tabName}-content`).classList.add('active');
            if(tabName==='minutes')updateMinutesTable();
            else if(tabName==='goals-assists')updateGoalsAssistsTable();
            else if(tabName==='most-improved')updateMostImprovedTable();
            else if(tabName==='power-ranking')updatePowerRankingTable();
            else if(tabName==='archived-players')renderArchivedPlayers();
            else if(tabName==='hall-of-fame')renderHallOfFame();
        });});
        /* Elements */
        const addPlayerBtn=document.getElementById('add-player-btn');
        const playerModal=document.getElementById('player-modal');
        const cancelBtn=document.getElementById('cancel-btn');
        const saveBtn=document.getElementById('save-btn');
        const confirmModal=document.getElementById('confirm-modal');
        const confirmCancelBtn=document.getElementById('confirm-cancel');
        const confirmDeleteBtn=document.getElementById('confirm-delete');
        const ageAllBtn=document.getElementById('age-all-btn');
        const fullMatchBtn=document.getElementById('full-match-btn');
        const minutesInput=document.getElementById('minutes-input');
        const confirmMinutesBtn=document.getElementById('confirm-minutes-btn');
        const undoMinutesBtn=document.getElementById('undo-minutes-btn');
        const undoGaBtn=document.getElementById('undo-ga-btn');
        const avgQualitySpan=document.getElementById('avg-quality');
        const resetTrainingBtn = document.getElementById('reset-training-btn');
        const endSeasonBtn = document.getElementById('end-season-btn');
        const downloadDataBtn = document.getElementById('download-data-btn');
        const uploadDataBtn = document.getElementById('upload-data-btn');
        const uploadFileInput = document.getElementById('upload-file-input');
        let currentPlayerId=null;let selectedPlayersForMinutes=[];let players=[];
        let minutesHistory=[];
        let gaHistory=[];
        let talentChart = null;
        let archivedPlayers = [];
        let previousPowerRanking = []; // This will now be loaded from localStorage
        let powerRankingTimeSeries = {}; // For the new chart
        let powerRankingChart = null;
        let selectedPowerRankingPlayers = [];
        let isEditingTrainingTimes = false;
        /* ARCHIVED PLAYERS STORAGE */
        function loadArchivedPlayersFromStorage() {
            archivedPlayers = JSON.parse(localStorage.getItem('archivedPlayers') || '[]');
        }
        function saveArchivedPlayersToStorage() {
            localStorage.setItem('archivedPlayers', JSON.stringify(archivedPlayers));
        }
        /* Utils */
        function getPositionCategory(pos){if(pos==='GK')return'gk';if(['DL','DC','DR'].includes(pos))return'def';if(['DMC','ML','MC','MR','AMC','AML','AMR'].includes(pos))return'mid';if(['ST'].includes(pos))return'att';return'';}
        function getPositionOrder(pos){const order={GK:0,DL:1,DC:2,DR:3,DMC:4,ML:5,MC:6,MR:7,AML:8,AMC:9,AMR:10,ST:11};return order[pos]||99;}
        function sortPlayers(){
            const sortOption = document.getElementById('sort-option')?.value || 'position';
            if (sortOption === 'quality') {
                // Sort by current quality (highest first)
                players.sort((a, b) => {
                    // Get current quality for player A
                    let currentQualityA = a.initialQuality;
                    for (let i = a.progress.length - 1; i >= 0; i--) {
                        if (a.progress[i] !== null && a.progress[i] !== undefined) {
                            currentQualityA = a.progress[i];
                            break;
                        }
                    }
                    // Get current quality for player B
                    let currentQualityB = b.initialQuality;
                    for (let i = b.progress.length - 1; i >= 0; i--) {
                        if (b.progress[i] !== null && b.progress[i] !== undefined) {
                            currentQualityB = b.progress[i];
                            break;
                        }
                    }
                    return currentQualityB - currentQualityA; // Descending order
                });
            } else {
                // Default position sorting
                const positionOrderCat={gk:0,def:1,mid:2,att:3};
                players.sort((a,b)=>{
                    const catA=getPositionCategory(a.positions[0]);
                    const catB=getPositionCategory(b.positions[0]);
                    if(catA!==catB)return positionOrderCat[catA]-positionOrderCat[catB];
                    return getPositionOrder(a.positions[0])-getPositionOrder(b.positions[0]);
                });
            }
        }
        function clearModal(){document.getElementById('player-name').value='';Array.from(document.getElementById('player-position').options).forEach(o=>o.selected=false);document.getElementById('player-age').value='';document.getElementById('player-quality').value='';document.getElementById('modal-title').textContent='Add New Player';currentPlayerId=null;}function calculateAverageQuality(){if(players.length===0){avgQualitySpan.textContent='--';document.getElementById('squad-count').textContent='0';document.getElementById('avg-age').textContent='--';return;}
            const avgQuality=(players.reduce((sum,p)=>sum+p.quality,0)/players.length).toFixed(1);
            const avgAge=(players.reduce((sum,p)=>sum+p.age,0)/players.length).toFixed(1);
            avgQualitySpan.textContent=avgQuality;
            document.getElementById('squad-count').textContent=players.length;
            document.getElementById('avg-age').textContent=avgAge;
        }
        function calculateDayAverages(){const averages=Array(28).fill(0);const counts=Array(28).fill(0);players.forEach(player=>{player.progress.forEach((value,day)=>{if(value!==null){averages[day]+=value;counts[day]++;}});});return averages.map((sum,day)=>{return counts[day]>0?(sum/counts[day]).toFixed(2)+'':'-';});}
        function ensureGaFields(p){
            ['leagueGoals','leagueAssists','clGoals','clAssists','cupGoals','cupAssists'].forEach(f=>{if(typeof p[f]!=='number')p[f]=0;});
            ['lifetimeMinutes', 'lifetimeMatches', 'lifetimeGoals', 'lifetimeAssists'].forEach(f => {
                if (typeof p[f] !== 'number') p[f] = 0;
            });
            if(p.comment===undefined)p.comment='';
            if(!p.tags){p.tags={keep:false,sell:false,slowTrainer:false,hotProspect:false};}
            if(!p.archiveReason) p.archiveReason = 'other'; // Default reason
        }
        /* Storage */
        function loadPlayersFromLocalStorage(){const saved=localStorage.getItem('topElevenPlayers');if(saved){players=JSON.parse(saved);players.forEach(p=>{if(!p.positions){p.positions=[p.position||''];}if(!p.position)p.position=p.positions[0];if(!p.progress)p.progress=Array(28).fill(null);if(!p.minutes)p.minutes=Array(28).fill(0);if(!p.initialQuality)p.initialQuality=p.quality;ensureGaFields(p);});}}
        function savePlayersToLocalStorage(){localStorage.setItem('topElevenPlayers',JSON.stringify(players));}
        
        function endSeason() {
            if (!confirm("Are you sure you want to end the current season? This will archive all current player data and reset their stats for a new season. This action cannot be undone.")) {
                return;
            }
            // 1. Get existing archives or create new array
            const archives = JSON.parse(localStorage.getItem('topElevenArchives') || '[]');
            
            // 2. Get current power ranking data
            const currentPowerRanking = JSON.parse(localStorage.getItem('powerRankingHistory') || '[]');
            const currentTimeSeries = JSON.parse(localStorage.getItem('powerRankingTimeSeries') || '{}');
            
            // 3. Create new archive object with power ranking data
            const seasonData = {
                seasonNumber: archives.length + 1,
                endDate: new Date().toLocaleDateString(),
                players: JSON.parse(JSON.stringify(players)), // Deep copy of players array
                powerRankingHistory: JSON.parse(JSON.stringify(currentPowerRanking)), // Deep copy
                powerRankingTimeSeries: JSON.parse(JSON.stringify(currentTimeSeries)) // Deep copy
            };
            
            // 4. Add new archive and save
            archives.push(seasonData);
            localStorage.setItem('topElevenArchives', JSON.stringify(archives));
            
            // 5. Clear power ranking data for the new season
            localStorage.removeItem('powerRankingHistory');
            localStorage.removeItem('powerRankingTimeSeries');
            previousPowerRanking = [];
            powerRankingTimeSeries = {};
            
            // 6. Reset players for the new season
            players.forEach(p => {
                // Accumulate lifetime stats before resetting
                const seasonGoals = (p.leagueGoals || 0) + (p.clGoals || 0) + (p.cupGoals || 0);
                const seasonAssists = (p.leagueAssists || 0) + (p.clAssists || 0) + (p.cupAssists || 0);
                
                p.lifetimeMinutes = (p.lifetimeMinutes || 0) + (p.totalMinutes || 0);
                p.lifetimeMatches = (p.lifetimeMatches || 0) + (p.matchesPlayed || 0);
                p.lifetimeGoals = (p.lifetimeGoals || 0) + seasonGoals;
                p.lifetimeAssists = (p.lifetimeAssists || 0) + seasonAssists;
                // Reset for new season
                p.initialQuality = p.quality; // New initial quality is the last season's final quality
                p.progress = Array(28).fill(null);
                p.minutes = Array(28).fill(0);
                p.totalMinutes = 0;
                p.matchesPlayed = 0;
                p.leagueGoals = 0;
                p.leagueAssists = 0;
                p.clGoals = 0;
                p.clAssists = 0;
                p.cupGoals = 0;
                p.cupAssists = 0;
            });
            
            // 7. Save the reset player data
            savePlayersToLocalStorage();
            
            // 8. Re-render everything
            alert(`Season ${seasonData.seasonNumber} has been archived with power ranking data. The new season is ready to begin!`);
            renderPlayers();
            loadAndRenderArchives();
            renderPowerRankingTable([]);
            renderPowerRankingChart();
        }
        /* CRUD */
        function addPlayer(name,positionsArr,age,quality){const primary=positionsArr[0];const player={id:Date.now(),name,position:primary,positions:positionsArr,age,quality,initialQuality:quality,progress:Array(28).fill(null),minutes:Array(28).fill(0),leagueGoals:0,leagueAssists:0,clGoals:0,clAssists:0,cupGoals:0,cupAssists:0,totalMinutes:0,matchesPlayed:0,comment:'',tags:{keep:false,sell:false,slowTrainer:false,hotProspect:false}, lifetimeMinutes: 0, lifetimeMatches: 0, lifetimeGoals: 0, lifetimeAssists: 0};players.push(player);return player;}
        function editPlayer(playerId){const player=players.find(p=>p.id===playerId);if(!player)return;currentPlayerId=playerId;document.getElementById('modal-title').textContent='Edit Player';document.getElementById('player-name').value=player.name;document.getElementById('player-age').value=player.age;document.getElementById('player-quality').value=player.quality;Array.from(document.getElementById('player-position').options).forEach(o=>{o.selected=player.positions.includes(o.value);});playerModal.style.display='flex';}
        function confirmDeletePlayer(playerId){const player=players.find(p=>p.id===playerId);if(!player)return;document.getElementById('player-to-delete').textContent=`${player.name} (${player.positions.join('/')})`;confirmModal.style.display='flex';confirmDeleteBtn.onclick=function(){players=players.filter(p=>p.id!==playerId);savePlayersToLocalStorage();renderPlayers();confirmModal.style.display='none';};}
        function ageAllPlayers(){players.forEach(p=>{if(p.age<45)p.age++;});savePlayersToLocalStorage();renderPlayers();}
        function addMinutesToSelected(minutes){
            const currentMatchDay=players[0]?.minutes.findIndex(m=>m===0);
            // Save state for undo
            const undoState={
                type:'addMinutes',
                players:selectedPlayersForMinutes.map(id=>{
                    const p=players.find(pl=>pl.id===id);
                    return {
                        id:id,
                        previousMinutes:p.minutes[currentMatchDay],
                        previousTotal:p.totalMinutes,
                        previousMatches:p.matchesPlayed,
                        matchDay:currentMatchDay,
                        addedMinutes:minutes
                    };
                })
            };
            minutesHistory.push(undoState);
            
            players.forEach(p=>{if(selectedPlayersForMinutes.includes(p.id)){
                // Add minutes to current match day (don't overwrite)
                p.minutes[currentMatchDay]=(p.minutes[currentMatchDay]||0)+minutes;
                // Add to total minutes
                p.totalMinutes=(p.totalMinutes||0)+minutes;
                // Increment matches every time minutes are added
                if(minutes>0)p.matchesPlayed=(p.matchesPlayed||0)+1;
            }});
            selectedPlayersForMinutes=[];
            savePlayersToLocalStorage();
            updateMinutesTable();
        }
        
        function undoLastMinutesChange(){
            if(minutesHistory.length===0){
                alert('No changes to undo');
                return;
            }
            
            const lastChange=minutesHistory.pop();
            if(lastChange.type==='addMinutes'){
                lastChange.players.forEach(playerData=>{
                    const p=players.find(pl=>pl.id===playerData.id);
                    if(p){
                        p.minutes[playerData.matchDay]=playerData.previousMinutes;
                        p.totalMinutes=playerData.previousTotal;
                        p.matchesPlayed=playerData.previousMatches;
                    }
                });
            }
            
            savePlayersToLocalStorage();
            updateMinutesTable();
        }// ARCHIVE PLAYER FUNCTION
        function archivePlayer(playerId) {
            const idx = players.findIndex(p => p.id === playerId);
            if (idx === -1) return;
            const playerToArchive = players[idx];
            if (!confirm(`Are you sure you want to archive ${playerToArchive.name}?`)) return;
            // Stamp the player with the season they are being archived in
            const archives = JSON.parse(localStorage.getItem('topElevenArchives') || '[]');
            playerToArchive.archivedInSeason = archives.length + 1;
            // Remove from active players, push to archivedPlayers
            players.splice(idx, 1);
            playerToArchive.archiveReason = 'other'; // Set default reason on archive
            archivedPlayers.push(playerToArchive);
            savePlayersToLocalStorage();
            saveArchivedPlayersToStorage();
            renderPlayers();
            renderArchivedPlayers();
        }

        // RENDER ARCHIVED PLAYERS
        // --- Archived Players Table Sorting State ---
        let archivedSortBy = 'name';
        let archivedSortOrder = 'asc';
        function renderArchivedPlayers() {
            loadArchivedPlayersFromStorage();
            archivedPlayers.forEach(p => ensureGaFields(p));
            // --- FILTERING LOGIC ---
            const posFilter = document.getElementById('archive-position-filter').value;
            const minAge = parseInt(document.getElementById('archive-age-filter-min').value) || 0;
            const maxAge = parseInt(document.getElementById('archive-age-filter-max').value) || Infinity;
            const minMinutes = parseInt(document.getElementById('archive-minutes-filter-min').value) || 0;
            const maxMinutes = parseInt(document.getElementById('archive-minutes-filter-max').value) || Infinity;
            const minMatches = parseInt(document.getElementById('archive-matches-filter-min').value) || 0;
            const maxMatches = parseInt(document.getElementById('archive-matches-filter-max').value) || Infinity;
            const minGoals = parseInt(document.getElementById('archive-goals-filter-min').value) || 0;
            const maxGoals = parseInt(document.getElementById('archive-goals-filter-max').value) || Infinity;
            const minAssists = parseInt(document.getElementById('archive-assists-filter-min').value) || 0;
            const maxAssists = parseInt(document.getElementById('archive-assists-filter-max').value) || Infinity;
            const filteredPlayers = archivedPlayers.filter(p => {
                const playerCategory = getPositionCategory(p.positions[0]);
                if (posFilter !== 'all' && playerCategory !== posFilter) return false;
                
                if (p.age < minAge || p.age > maxAge) return false;
                
                const totalMinutes = p.totalMinutes || 0;
                const matchesPlayed = p.matchesPlayed || 0;
                const totalGoals = (p.leagueGoals || 0) + (p.clGoals || 0) + (p.cupGoals || 0);
                const totalAssists = (p.leagueAssists || 0) + (p.clAssists || 0) + (p.cupAssists || 0);
                if (totalMinutes < minMinutes || totalMinutes > maxMinutes) return false;
                if (matchesPlayed < minMatches || matchesPlayed > maxMatches) return false;
                if (totalGoals < minGoals || totalGoals > maxGoals) return false;
                if (totalAssists < minAssists || totalAssists > maxAssists) return false;
                return true;
            });
            const tbody = document.querySelector('#archived-players-table tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            
            if (!filteredPlayers.length) {
                const message = archivedPlayers.length > 0 ? 'No players match the current filters.' : 'No players have been archived yet.';
                tbody.innerHTML = `<tr><td colspan="11">${message}</td></tr>`;
                return;
            }
            // Prepare data for sorting from the filtered list
            const data = filteredPlayers.map(p => {
                // We need to find the original index to allow editing/deleting
                const originalIndex = archivedPlayers.findIndex(original => original.id === p.id);
                let currentQuality = p.initialQuality;
                if (p.progress) {
                    for (let i = p.progress.length - 1; i >= 0; i--) {
                        if (p.progress[i] !== null && p.progress[i] !== undefined) {
                            currentQuality = p.progress[i];
                            break;
                        }
                    }
                }
                const totalGoals = (p.leagueGoals||0)+(p.clGoals||0)+(p.cupGoals||0);
                const totalAssists = (p.leagueAssists||0)+(p.clAssists||0)+(p.cupAssists||0);
                const improvement = (currentQuality - p.initialQuality) || 0;
                const improvementPercent = p.initialQuality > 0 ? (improvement / p.initialQuality * 100) : 0;
                const ga = totalGoals + totalAssists;
                const gaPer90 = (p.totalMinutes || 0) > 0 ? (ga * 90) / p.totalMinutes : 0;
                const avgMinPerMatch = (p.matchesPlayed || 0) > 0 ? (p.totalMinutes || 0) / p.matchesPlayed : 0;
                return {
                    idx: originalIndex, // Use original index for data manipulation
                    name: p.name,
                    positions: p.positions,
                    age: p.age,
                    initialQuality: p.initialQuality,
                    currentQuality,
                    improvement,
                    improvementPercent,
                    minutes: p.totalMinutes || 0,
                    matches: p.matchesPlayed || 0,
                    goals: totalGoals,
                    assists: totalAssists,
                    gaPer90: gaPer90,
                    avgMinPerMatch: avgMinPerMatch,
                    archiveReason: p.archiveReason || 'other',
                    player: p
                };
            });
            // Sort
            data.sort((a, b) => {
                let valA = a[archivedSortBy], valB = b[archivedSortBy];
                if (archivedSortBy === 'avgMinPerMatch') {
                    valA = a.avgMinPerMatch;
                    valB = b.avgMinPerMatch;
                }
                if (typeof valA === 'string') {
                    return archivedSortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    return archivedSortOrder === 'asc' ? valA - valB : valB - valA;
                }
            });
            // Render rows
            data.forEach(item => {
                const p = item.player;
                const row = document.createElement('tr');
                // Name (bold surname)
                const nameParts = p.name.split(' ');
                let nameHtml = p.name.includes(' ') ? `${p.name.substring(0, p.name.lastIndexOf(' '))} <span class="player-name-bold">${p.name.substring(p.name.lastIndexOf(' ') + 1)}</span>` : `<span class="player-name-bold">${p.name}</span>`;
                
                const reasons = {
                    sold: 'Sold',
                    retired: 'Retired',
                    end_of_contract: 'End of Contract',
                    not_good_enough: 'Not Good Enough',
                    other: 'Other'
                };
                let reasonOptions = '';
                for(const [key, value] of Object.entries(reasons)) {
                    reasonOptions += `<option value="${key}" ${item.archiveReason === key ? 'selected' : ''}>${value}</option>`;
                }
                row.innerHTML = `
                    <td>${nameHtml}</td>
                    <td>${p.positions.join('/')}</td>
                    <td><input type="number" class="editable-stat" value="${p.age}" data-idx="${item.idx}" data-field="age"></td>
                    <td><input type="number" class="editable-stat" value="${item.minutes}" data-idx="${item.idx}" data-field="totalMinutes"></td>
                    <td><input type="number" class="editable-stat" value="${item.matches}" data-idx="${item.idx}" data-field="matchesPlayed"></td>
                    <td>${item.avgMinPerMatch.toFixed(1)}</td>
                    <td><input type="number" class="editable-stat" value="${item.goals}" data-idx="${item.idx}" data-field="goals"></td>
                    <td><input type="number" class="editable-stat" value="${item.assists}" data-idx="${item.idx}" data-field="assists"></td>
                    <td>${item.gaPer90.toFixed(2)}</td>
                    <td><select class="editable-stat" data-idx="${item.idx}" data-field="archiveReason">${reasonOptions}</select></td>
                    <td><button class='delete-btn' data-idx='${item.idx}'>Delete</button></td>
                `;
                tbody.appendChild(row);
            });
            // Update sort indicators
            const table = document.getElementById('archived-players-table');
            if (table) {
                table.querySelectorAll('th[data-sort]').forEach(th => {
                    th.dataset.order = '';
                    const ind = th.querySelector('.sort-indicator');
                    if (ind) ind.className = 'sort-indicator';
                    if (th.dataset.sort === archivedSortBy) {
                        th.dataset.order = archivedSortOrder;
                        if (ind) ind.classList.add(archivedSortOrder);
                    }
                });
            }
            // Delete event
            tbody.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const idx = parseInt(this.dataset.idx);
                    if (confirm(`Are you sure you want to delete archived player ${archivedPlayers[idx].name}?`)) {
                        archivedPlayers.splice(idx, 1);
                        saveArchivedPlayersToStorage();
                        renderArchivedPlayers();
                    }
                });
            });
            // Editable stats event
            tbody.querySelectorAll('.editable-stat').forEach(input => {
                input.addEventListener('change', function(e) {
                    e.stopPropagation();
                    const idx = parseInt(this.dataset.idx);
                    const field = this.dataset.field;
                    const isNumeric = this.type === 'number';
                    const value = isNumeric ? parseInt(this.value) : this.value;
                    if (isNumeric && isNaN(value)) return;
                    
                    const player = archivedPlayers[idx];
                    if (field === 'goals' || field === 'assists') {
                        // This is a simplified update. If individual competition stats are needed, this would need to be more complex.
                        // For now, we assume this sets a general 'league' goal/assist count.
                        // To keep things simple, we'll assign the total value to the 'league' stat
                        // and ensure other competition stats are preserved if they exist.
                        if (field === 'goals') {
                            // Set the league goals to the new total, and reset others.
                            player.leagueGoals = value;
                            player.clGoals = 0;
                            player.cupGoals = 0;
                        } else { // assists
                            // Set the league assists to the new total, and reset others.
                            player.leagueAssists = value;
                            player.clAssists = 0;
                            player.cupAssists = 0;
                        }
                    } else {
                        player[field] = value;
                    }
                    
                    saveArchivedPlayersToStorage();
                    renderArchivedPlayers();
                });
            });
        }

        /* Render active players (napredak) */
        function renderPlayers(){
            sortPlayers();const list=document.getElementById('player-list');list.innerHTML='';const dayAverages=calculateDayAverages();const header=document.createElement('div');header.className='player-card';header.style.pointerEvents='none';header.style.backgroundColor='transparent';header.style.boxShadow='none';const dummyInfo=document.createElement('div');dummyInfo.className='player-info';dummyInfo.style.visibility='hidden';header.appendChild(dummyInfo);const weeksContainer=document.createElement('div');weeksContainer.className='weeks-container';
            for(let week=1;week<=4;week++){const weekHeader=document.createElement('div');weekHeader.className='week-header';const weekLabel=document.createElement('div');weekLabel.className='week-label';weekLabel.textContent=`Week ${week}:`;weekHeader.appendChild(weekLabel);const daysCells=document.createElement('div');daysCells.className='days-header';const startDay=(week-1)*7+1;const endDay=Math.min(week*7,28);for(let i=startDay;i<=endDay;i++){const cell=document.createElement('div');cell.className='day-cell';cell.textContent=i;daysCells.appendChild(cell);}weekHeader.appendChild(daysCells);weeksContainer.appendChild(weekHeader);}header.appendChild(weeksContainer);
            const averagesRow=document.createElement('div');averagesRow.className='player-card';averagesRow.style.pointerEvents='none';averagesRow.style.backgroundColor='transparent';averagesRow.style.boxShadow='none';const avgLabel=document.createElement('div');avgLabel.className='player-info';avgLabel.textContent='Avg:';avgLabel.style.fontWeight='bold';avgLabel.style.fontSize='11px';averagesRow.appendChild(avgLabel);const avgWeeksContainer=document.createElement('div');avgWeeksContainer.className='weeks-container';
            for(let week=1;week<=4;week++){const avgWeekHeader=document.createElement('div');avgWeekHeader.className='week-header';const avgWeekLabel=document.createElement('div');avgWeekLabel.className='week-label';avgWeekLabel.style.visibility='hidden';avgWeekLabel.textContent=`Week ${week}:`;avgWeekHeader.appendChild(avgWeekLabel);const avgValues=document.createElement('div');avgValues.className='player-days';const startDay=(week-1)*7;const endDay=Math.min(week*7-1,27);for(let i=startDay;i<=endDay;i++){const avgCell=document.createElement('div');avgCell.className='day-average';avgCell.textContent=dayAverages[i];avgValues.appendChild(avgCell);}avgWeekHeader.appendChild(avgValues);avgWeeksContainer.appendChild(avgWeekHeader);}averagesRow.appendChild(avgWeeksContainer);
            list.appendChild(header);list.appendChild(averagesRow);
            players.forEach(p=>{
                const card=document.createElement('div');
                card.className='player-card';
                card.dataset.playerId=p.id;
                const info=document.createElement('div');
                info.className='player-info';
                p.positions.forEach(pos=>{
                    const lab=document.createElement('span');
                    lab.className=`position-label ${getPositionCategory(pos)}`;
                    lab.textContent=pos;
                    info.appendChild(lab);
                });
                // Create name with bold surname
                const nameSpan=document.createElement('span');
                const nameParts=p.name.split(' ');
                if(nameParts.length>1){
                    const firstName=nameParts.slice(0,-1).join(' ');
                    const surname=nameParts[nameParts.length-1];
                    nameSpan.innerHTML=`${firstName} <span class="player-name-bold">${surname}</span> (${p.age}, ${p.quality}%)`;
                }else{
                    nameSpan.innerHTML=`<span class="player-name-bold">${p.name}</span> (${p.age}, ${p.quality}%)`;
                }
                info.appendChild(nameSpan);
                // Star
                const starDiv=document.createElement('div');
                starDiv.className='star-rating';
                const starsBase='★★★★★';
                starDiv.innerHTML=`<span class='stars-outer'>${starsBase}</span><span class='stars-inner' style='width:${Math.min(p.quality,100)}%'>${starsBase}</span>`;
                info.appendChild(starDiv);
                // Favorite star
                // Tags
                const tagsContainer=document.createElement('div');
                tagsContainer.className='card-tags-container';
                tagsContainer.addEventListener('click', e => e.stopPropagation());
                const tags = {
                    keep: { short: 'K', title: 'Keep', color: '#28a745' },
                    sell: { short: 'S', title: 'Sell', color: '#dc3545' },
                    slowTrainer: { short: 'SL', title: 'Slow Trainer', color: '#ffc107' },
                    hotProspect: { short: 'H', title: 'Hot Prospect', color: '#17a2b8' }
                };
                for (const key in tags) {
                    const tagEl = document.createElement('div');
                    tagEl.className = `card-tag ${p.tags[key] ? 'active' : ''}`;
                    tagEl.textContent = tags[key].short;
                    tagEl.title = tags[key].title;
                    if (p.tags[key]) {
                        tagEl.style.backgroundColor = tags[key].color;
                        tagEl.style.borderColor = tags[key].color;
                    }
                    tagEl.addEventListener('click', () => {
                        p.tags[key] = !p.tags[key];
                        savePlayersToLocalStorage();
                        renderPlayers();
                        if(document.getElementById('notes-content').classList.contains('active')) {
                           renderNotesTab();
                        }
                    });
                    tagsContainer.appendChild(tagEl);
                }
                info.appendChild(tagsContainer);
                card.appendChild(info);
                
                // Button Container
                const buttonContainer = document.createElement('div');
                buttonContainer.style.display = 'flex';
                buttonContainer.style.gap = '8px';
                buttonContainer.style.flexShrink = '0'; // Prevent buttons from shrinking
                
                // Edit button
                const editBtn=document.createElement('button');
                editBtn.className='edit-btn';
                editBtn.textContent='Edit';
                editBtn.addEventListener('click',(e)=>{
                    e.stopPropagation();
                    editPlayer(p.id);
                });
                buttonContainer.appendChild(editBtn);
                
                // Archive button (NEW)
                const archiveBtn=document.createElement('button');
                archiveBtn.className='archive-btn';
                archiveBtn.textContent='Archive';
                archiveBtn.addEventListener('click',(e)=>{
                    e.stopPropagation();
                    archivePlayer(p.id);
                });
                buttonContainer.appendChild(archiveBtn);
                card.appendChild(buttonContainer);
                // Weeks container for progress input
                const playerWeeksContainer=document.createElement('div');
                playerWeeksContainer.className='weeks-container';
                for(let week=1;week<=4;week++){
                    const playerWeekHeader=document.createElement('div');
                    playerWeekHeader.className='week-header';
                    const playerWeekLabel=document.createElement('div');
                    playerWeekLabel.className='week-label';
                    playerWeekLabel.style.visibility='hidden';
                    playerWeekLabel.textContent=`Week ${week}:`;
                    playerWeekHeader.appendChild(playerWeekLabel);
                    const daysDiv=document.createElement('div');
                    daysDiv.className='player-days';
                    const startDay=(week-1)*7;
                    const endDay=Math.min(week*7-1,27);
                    for(let i=startDay;i<=endDay;i++){
                        const inp=document.createElement('input');
                        inp.className='player-day-input';
                        inp.type='number';
                        inp.min='0';
                        inp.max='100';
                        inp.value=p.progress[i]||'';
                        inp.dataset.day=i;
                        inp.addEventListener('change',function(e){
                            e.stopPropagation();
                            const d=parseInt(this.dataset.day);
                            const v=this.value?parseInt(this.value):null;
                            p.progress[d]=v;
                            savePlayersToLocalStorage();
                            renderPlayers();
                        });
                        inp.addEventListener('click',function(e){
                            e.stopPropagation();
                        });
                        daysDiv.appendChild(inp);
                    }
                    playerWeekHeader.appendChild(daysDiv);
                    playerWeeksContainer.appendChild(playerWeekHeader);
                }
                card.appendChild(playerWeeksContainer);
                card.addEventListener('click',function(e){
                    if(e.target.tagName==='INPUT'||e.target.tagName==='BUTTON')return;
                });
                list.appendChild(card);
            });
            calculateAverageQuality();
        }
        
        function loadAndRenderArchives() {
            const archiveListDiv = document.getElementById('archive-list');
            const archives = JSON.parse(localStorage.getItem('topElevenArchives') || '[]');
            
            if (archives.length === 0) {
                archiveListDiv.innerHTML = '<p>No archived seasons yet.</p>';
                return;
            }
            
            archiveListDiv.innerHTML = ''; // Clear existing
            
            archives.reverse().forEach(archive => { // Show newest first
                const details = document.createElement('details');
                details.className = 'archive-details';
                
                const summary = document.createElement('summary');
                summary.className = 'archive-summary';
                summary.style.display = 'flex';
                summary.style.alignItems = 'center';
                summary.style.justifyContent = 'space-between';
                
                const summaryText = document.createElement('span');
                summaryText.innerHTML = `<strong>Season ${archive.seasonNumber}</strong> (Ended on: ${archive.endDate}) - ${archive.players.length} players`;
                summary.appendChild(summaryText);
                
                // Add "View Power Rankings" button if data exists
                if (archive.powerRankingHistory && archive.powerRankingHistory.length > 0) {
                    const viewPrBtn = document.createElement('button');
                    viewPrBtn.className = 'view-pr-btn';
                    viewPrBtn.textContent = 'View Power Rankings';
                    viewPrBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showArchivedPowerRanking(archive);
                    });
                    summary.appendChild(viewPrBtn);
                }
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'archive-content';
                
                details.appendChild(summary);
                details.appendChild(contentDiv);
                
                details.addEventListener('toggle', () => {
                    if (details.open && !contentDiv.hasChildNodes()) {
                        renderArchivedSeasonPlayers(contentDiv, archive.players);
                    }
                });
                
                archiveListDiv.appendChild(details);
            });
        }
        
        function downloadData() {
            const dataToSave = {
                players: JSON.parse(localStorage.getItem('topElevenPlayers') || '[]'),
                archives: JSON.parse(localStorage.getItem('topElevenArchives') || '[]'),
                trainingBonuses: JSON.parse(localStorage.getItem('trainingBonuses') || '{}'),
                powerRankingHistory: JSON.parse(localStorage.getItem('powerRankingHistory') || '[]'),
                powerRankingTimeSeries: JSON.parse(localStorage.getItem('powerRankingTimeSeries') || '{}')
            };
            
            const dataStr = JSON.stringify(dataToSave, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `top_eleven_tracker_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function uploadData(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }
            if (!confirm("Are you sure you want to upload this file? This will overwrite all current data in the tracker.")) {
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.players && data.archives && data.trainingBonuses && data.powerRankingHistory && data.powerRankingTimeSeries) {
                        localStorage.setItem('topElevenPlayers', JSON.stringify(data.players));
                        localStorage.setItem('topElevenArchives', JSON.stringify(data.archives));
                        localStorage.setItem('trainingBonuses', JSON.stringify(data.trainingBonuses));
                        localStorage.setItem('powerRankingHistory', JSON.stringify(data.powerRankingHistory));
                        localStorage.setItem('powerRankingTimeSeries', JSON.stringify(data.powerRankingTimeSeries));
                        
                        // Reload and re-render all data
                        loadPlayersFromLocalStorage();
                        loadAndRenderArchives();
                        loadPowerRankingData();
                        
                        // Trigger re-render of all tabs
                        document.querySelectorAll('.tab').forEach(tab => {
                            if (tab.classList.contains('active')) {
                                tab.click(); // Re-click the active tab to force its render function
                            }
                        });
                        renderPlayers(); // Render progress tab
                        
                        alert('Data successfully uploaded and restored!');
                    } else {
                        alert('Error: The uploaded file has an invalid format.');
                    }
                } catch (error) {
                    alert('Error reading or parsing the file. Please ensure it is a valid JSON backup file.');
                    console.error("Upload error:", error);
                }
            };
            reader.readAsText(file);
            
            // Reset the input so the same file can be uploaded again if needed
            event.target.value = '';
        }

        function renderArchivedSeasonPlayers(container, archivedPlayers) {
            container.innerHTML = ''; // Clear container

            // Header with week/day numbers
            const header = document.createElement('div');
            header.className = 'player-card';
            header.style.cssText = 'pointer-events: none; background-color: transparent; box-shadow: none;';

            const dummyInfo = document.createElement('div');
            dummyInfo.className = 'player-info';
            dummyInfo.style.visibility = 'hidden';
            header.appendChild(dummyInfo);

            const weeksContainer = document.createElement('div');
            weeksContainer.className = 'weeks-container';
            for (let week = 1; week <= 4; week++) {
                const weekHeader = document.createElement('div');
                weekHeader.className = 'week-header';
                const weekLabel = document.createElement('div');
                weekLabel.className = 'week-label';
                weekLabel.textContent = `Week ${week}:`;
                weekHeader.appendChild(weekLabel);
                const daysCells = document.createElement('div');
                daysCells.className = 'days-header';
                const startDay = (week - 1) * 7 + 1;
                const endDay = Math.min(week * 7, 28);
                for (let i = startDay; i <= endDay; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'day-cell';
                    cell.textContent = i;
                    daysCells.appendChild(cell);
                }
                weekHeader.appendChild(daysCells);
                weeksContainer.appendChild(weekHeader);
            }
            header.appendChild(weeksContainer);
            container.appendChild(header);

            // Player rows
            archivedPlayers.forEach(p => {
                const card = document.createElement('div');
                card.className = 'player-card';

                const info = document.createElement('div');
                info.className = 'player-info';
                
                let currentQuality = p.initialQuality;
                if (p.progress) {
                    for (let i = p.progress.length - 1; i >= 0; i--) {
                        if (p.progress[i] !== null && p.progress[i] !== undefined) {
                            currentQuality = p.progress[i];
                            break;
                        }
                    }
                }
                const totalGoals = (p.leagueGoals || 0) + (p.clGoals || 0) + (p.cupGoals || 0);
                const totalAssists = (p.leagueAssists || 0) + (p.clAssists || 0) + (p.cupAssists || 0);
                const totalMinutes = p.totalMinutes || 0;
                const matchesPlayed = p.matchesPlayed || 0;
                info.innerHTML = `
                    <span class="position-label ${getPositionCategory(p.positions[0])}">${p.positions.join('/')}</span>
                    <span style="min-width: 180px;">${p.name} (${p.age}, ${currentQuality}%)</span>
                    <span style="margin-left: 15px; font-size: 11px; color: #333;">
                        <b>Min:</b> ${totalMinutes} | <b>M:</b> ${matchesPlayed} | <b>G:</b> ${totalGoals} | <b>A:</b> ${totalAssists}
                    </span>
                `;
                card.appendChild(info);

                const playerWeeksContainer = document.createElement('div');
                playerWeeksContainer.className = 'weeks-container';
                for (let week = 1; week <= 4; week++) {
                    const playerWeekHeader = document.createElement('div');
                    playerWeekHeader.className = 'week-header';
                    const playerWeekLabel = document.createElement('div');
                    playerWeekLabel.className = 'week-label';
                    playerWeekLabel.style.visibility = 'hidden';
                    playerWeekHeader.appendChild(playerWeekLabel);
                    
                    const daysDiv = document.createElement('div');
                    daysDiv.className = 'player-days';
                    const startDay = (week - 1) * 7;
                    const endDay = Math.min(week * 7 - 1, 27);
                    for (let i = startDay; i <= endDay; i++) {
                        const dayCell = document.createElement('div');
                        dayCell.className = 'player-day-input'; // Use same class for styling
                        dayCell.style.backgroundColor = '#f0f0f0';
                        dayCell.style.border = '1px solid #e0e0e0';
                        dayCell.textContent = p.progress[i] || '';
                        daysDiv.appendChild(dayCell);
                    }
                    playerWeekHeader.appendChild(daysDiv);
                    playerWeeksContainer.appendChild(playerWeekHeader);
                }
                card.appendChild(playerWeeksContainer);
                container.appendChild(card);
            });
        }
        
        function updateMinutesTable(){const tbody=document.querySelector('#minutes-table tbody');tbody.innerHTML='';
            const allMinutes=players.map(p=>(p.totalMinutes||0));
            const maxMinutes=Math.max(...allMinutes);
            const minMinutes=Math.min(...allMinutes);
            
            function getMinuteColor(minutes){
                if(maxMinutes===minMinutes||minutes===0) return 'transparent'; // No color if all same or zero
                const ratio=(minutes-minMinutes)/(maxMinutes-minMinutes);
                // Hue from blue (240) to red (0)
                const hue=240-(ratio*240);
                return `hsl(${hue}, 80%, 85%)`;
            }
            players.forEach(p=>{
                const total=p.totalMinutes||0;
                const matches=p.matchesPlayed||0;
                const row=document.createElement('tr');
                row.dataset.playerId=p.id;
                
                // Set selection class if player is selected
                if(selectedPlayersForMinutes.includes(p.id)){
                    row.classList.add('selected');
                }
                // Apply color coding
                row.style.backgroundColor=getMinuteColor(total);
                // Create name with bold surname
                const nameParts=p.name.split(' ');
                let displayName;
                if(nameParts.length>1){
                    const firstName=nameParts.slice(0,-1).join(' ');
                    const surname=nameParts[nameParts.length-1];
                    displayName=`${firstName} <span class="player-name-bold">${surname}</span>`;
                }else{
                    displayName=`<span class="player-name-bold">${p.name}</span>`;
                }
                
                row.innerHTML=`<td>${displayName}</td><td class='${getPositionCategory(p.positions[0])}'>${p.positions.join('/')}</td><td>${p.age}</td><td>${p.quality}</td><td>${total}</td><td>${matches}</td>`;
                
                // Add reset button cell
                const actionsCell=document.createElement('td');
                const resetBtn=document.createElement('button');
                resetBtn.className='reset-player-minutes-btn';
                resetBtn.textContent='Reset';
                resetBtn.dataset.playerId=p.id;
                actionsCell.appendChild(resetBtn);
                row.appendChild(actionsCell);
                
                row.addEventListener('click',function(e){
                    if(e.target.classList.contains('reset-player-minutes-btn'))return;
                    
                    const id=parseInt(this.dataset.playerId);
                    this.classList.toggle('selected');
                    if(this.classList.contains('selected')){
                        if(!selectedPlayersForMinutes.includes(id))selectedPlayersForMinutes.push(id);
                    }else{
                        selectedPlayersForMinutes=selectedPlayersForMinutes.filter(x=>x!==id);
                    }
                });
                tbody.appendChild(row);
            });
        }
function updateGoalsAssistsTable(){
            const tbody=document.querySelector('#goals-assists-table tbody');
            tbody.innerHTML='';
            players.forEach(p => {
                ensureGaFields(p);
                // Get current quality
                let currentQuality = p.initialQuality;
                for (let i = p.progress.length - 1; i >= 0; i--) {
                    if (p.progress[i] !== null && p.progress[i] !== undefined) {
                        currentQuality = p.progress[i];
                        break;
                    }
                }
                const totalGoals=p.leagueGoals+p.clGoals+p.cupGoals;
                const totalAssists=p.leagueAssists+p.clAssists+p.cupAssists;
                const ga=totalGoals+totalAssists;
                const totalMinutes=p.totalMinutes||0;
                
                let goalsPer90 = totalMinutes > 0 ? (totalGoals * 90) / totalMinutes : 0;
                let assistsPer90 = totalMinutes > 0 ? (totalAssists * 90) / totalMinutes : 0;
                let gaPer90 = totalMinutes > 0 ? (ga * 90) / totalMinutes : 0;
                const row=document.createElement('tr');
                row.dataset.playerId=p.id;
                
                const nameParts=p.name.split(' ');
                let displayName = nameParts.length > 1 ? `${nameParts.slice(0,-1).join(' ')} <span class="player-name-bold">${nameParts[nameParts.length-1]}</span>` : `<span class="player-name-bold">${p.name}</span>`;
                row.innerHTML=`<td>${displayName}</td><td class='${getPositionCategory(p.positions[0])}'>${p.positions.join('/')}</td><td>${p.age}</td><td>${currentQuality}%</td>`;
                
                const comps=['league','cl','cup'];
                comps.forEach(c => {
                    // Goals
                    let tdG=document.createElement('td');
                    tdG.innerHTML=`<div class="ga-control">
                        <button class="ga-btn minus" data-field="${c}Goals" data-op="-1">-</button>
                        <span class="ga-value ${c}-color">${p[`${c}Goals`]}</span>
                        <button class="ga-btn plus" data-field="${c}Goals" data-op="1">+</button>
                    </div>`;
                    row.appendChild(tdG);
                    // Assists
                    let tdA=document.createElement('td');
                    tdA.innerHTML=`<div class="ga-control">
                        <button class="ga-btn minus" data-field="${c}Assists" data-op="-1">-</button>
                        <span class="ga-value ${c}-color">${p[`${c}Assists`]}</span>
                        <button class="ga-btn plus" data-field="${c}Assists" data-op="1">+</button>
                    </div>`;
                    row.appendChild(tdA);
                });
                
                row.innerHTML+=`<td class="stats-separator">${totalGoals}</td><td>${totalAssists}</td><td>${ga}</td><td class="per90-separator">${goalsPer90.toFixed(2)}</td><td>${assistsPer90.toFixed(2)}</td><td>${gaPer90.toFixed(2)}</td>`;
                tbody.appendChild(row);
            });
        }
        /* Delegated event for GA inputs */
        document.getElementById('goals-assists-table').addEventListener('click', function(e) {
            if (e.target.classList.contains('ga-btn')) {
                const row = e.target.closest('tr');
                const pid = parseInt(row.dataset.playerId);
                const field = e.target.dataset.field;
                const operation = parseInt(e.target.dataset.op);
                const p = players.find(pl => pl.id === pid);
                if (p) {
                    const previousValue = p[field];
                    const newValue = Math.max(0, (p[field] || 0) + operation); // Ensure value doesn't go below 0
                    if (previousValue === newValue) return; // Nothing changed
                    // Save state for undo
                    const undoState = {
                        type: 'changeGA',
                        playerId: pid,
                        field: field,
                        previousValue: previousValue,
                        newValue: newValue
                    };
                    gaHistory.push(undoState);
                    p[field] = newValue;
                    savePlayersToLocalStorage();
                    updateGoalsAssistsTable();
                }
            }
        });
        
        function undoLastGaChange(){
            if(gaHistory.length===0){
                alert('No changes to undo');
                return;
            }
            
            const lastChange=gaHistory.pop();
            if(lastChange.type==='changeGA'){
                const p=players.find(pl=>pl.id===lastChange.playerId);
                if(p){
                    p[lastChange.field]=lastChange.previousValue;
                }
            }
            
            savePlayersToLocalStorage();
            updateGoalsAssistsTable();
        }
        
function updateMostImprovedTable(sortBy = 'improvement', sortOrder = 'desc') {
    const tbody = document.querySelector('#most-improved-table tbody');
    tbody.innerHTML = '';
    
    // Calculate improvement for each player
    const improvements = players.map(p => {
        let currentQuality = p.initialQuality;
        for (let i = p.progress.length - 1; i >= 0; i--) {
            if (p.progress[i] !== null && p.progress[i] !== undefined) {
                currentQuality = p.progress[i];
                break;
            }
        }
        
        const totalGoals = (p.leagueGoals || 0) + (p.clGoals || 0) + (p.cupGoals || 0);
        const totalAssists = (p.leagueAssists || 0) + (p.clAssists || 0) + (p.cupAssists || 0);
        const improvement = currentQuality - p.initialQuality;
        const improvementPercent = p.initialQuality > 0 ? (improvement / p.initialQuality * 100) : 0;
        
        return {
            player: p,
            initialQuality: p.initialQuality,
            currentQuality: currentQuality,
            improvement: improvement,
            improvementPercent: improvementPercent,
            totalGoals: totalGoals,
            totalAssists: totalAssists,
            avgMinPerMatch: (p.matchesPlayed || 0) > 0 ? (p.totalMinutes || 0) / p.matchesPlayed : 0
        };
    });
    // Sorting logic
    improvements.sort((a, b) => {
        let valA, valB;
        switch(sortBy) {
            case 'player': valA = a.player.name; valB = b.player.name; break;
            case 'age': valA = a.player.age; valB = b.player.age; break;
            case 'initialQuality': valA = a.initialQuality; valB = b.initialQuality; break;
            case 'currentQuality': valA = a.currentQuality; valB = b.currentQuality; break;
            case 'minutes': valA = a.player.totalMinutes || 0; valB = b.player.totalMinutes || 0; break;
            case 'matches': valA = a.player.matchesPlayed || 0; valB = b.player.matchesPlayed || 0; break;
            case 'g': valA = a.totalGoals; valB = b.totalGoals; break;
            case 'a': valA = a.totalAssists; valB = b.totalAssists; break;
            case 'avgMinPerMatch': valA = a.avgMinPerMatch; valB = b.avgMinPerMatch; break;
            case 'improvementPercent': valA = a.improvementPercent; valB = b.improvementPercent; break;
            default: // improvement
                valA = a.improvement; valB = b.improvement; break;
        }
        if (typeof valA === 'string') {
            return sortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
        } else {
            return sortOrder === 'asc' ? valA - valB : valB - valA;
        }
    });
    // Render table
    improvements.forEach((item, index) => {
        const p = item.player;
        const row = document.createElement('tr');
        const rank = index + 1;
        const improvementClass = item.improvement > 0 ? 'color:green' : item.improvement < 0 ? 'color:red' : '';
        const improvementSign = item.improvement > 0 ? '+' : '';
        row.innerHTML = `
            <td>${rank}</td>
            <td>${p.name}</td>
            <td class='${getPositionCategory(p.positions[0])}'>${p.positions.join('/')}</td>
            <td>${p.age}</td>
            <td>${item.initialQuality}%</td>
            <td>${item.currentQuality}%</td>
            <td>${p.totalMinutes || 0}</td>
            <td>${p.matchesPlayed || 0}</td>
            <td>${item.avgMinPerMatch.toFixed(1)}</td>
            <td>${item.totalGoals}</td>
            <td>${item.totalAssists}</td>
            <td style='${improvementClass}'>${improvementSign}${item.improvement}%</td>
            <td style='${improvementClass}'>${improvementSign}${item.improvementPercent.toFixed(1)}%</td>
        `;
        tbody.appendChild(row);
    });
    // Render the chart with the calculated data
    renderTalentChart(improvements);
}
        
        function setupTrainingCalculator() {
            let trainingTimes = JSON.parse(localStorage.getItem('trainingTimes') || '["23:10", "2:10", "5:10", "8:10", "11:10", "14:10", "17:10", "20:10"]');
            const tbody = document.querySelector('#training-table tbody');
            tbody.innerHTML = ''; // Clear previous
            
            trainingTimes.forEach((time, index) => {
                const row = document.createElement('tr');
                let timeCellContent = isEditingTrainingTimes 
                    ? `<td><input type="text" class="training-time-input" value="${time}" data-index="${index}"></td>`
                    : `<td>${time}</td>`;
                row.innerHTML = `
                    ${timeCellContent}
                    <td><input type="number" class="training-input" data-time="${time}" min="0" placeholder="0"></td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('most-improved-content').addEventListener('input', function(e){
                if(e.target.classList.contains('training-input')) {
                    updateTrainingSummary();
                }
            });
            loadTrainingBonuses();
        }
        
        function updateTrainingSummary() {
            const inputs = document.querySelectorAll('.training-input');
            let sum = 0;
            const trainingValues = {};
            inputs.forEach(input => {
                const value = parseInt(input.value) || 0;
                sum += value;
                trainingValues[input.dataset.time] = value;
            });
            
            const rangeHigh = 99 - sum;
            const rangeLow = 94 - sum;
            document.getElementById('training-range').textContent = `${rangeLow}% - ${rangeHigh}%`;
            
            localStorage.setItem('trainingBonuses', JSON.stringify(trainingValues));
        }
        
        function loadTrainingBonuses() {
            const savedBonuses = localStorage.getItem('trainingBonuses');
            if (savedBonuses) {
                const trainingValues = JSON.parse(savedBonuses);
                const inputs = document.querySelectorAll('.training-input');
                inputs.forEach(input => {
                    const time = input.dataset.time;
                    if (trainingValues[time]) {
                        input.value = trainingValues[time];
                    }
                });
            }
            updateTrainingSummary();
        }
        
        function resetTrainingCalculator() {
            const inputs = document.querySelectorAll('.training-input');
            inputs.forEach(input => {
                input.value = '';
            });
            updateTrainingSummary();
        }
        function handleEditSaveTrainingTimes() {
            const btn = document.getElementById('edit-training-times-btn');
            isEditingTrainingTimes = !isEditingTrainingTimes;
            if (isEditingTrainingTimes) {
                // Now in edit mode
                btn.textContent = 'Save Times';
                btn.style.backgroundColor = '#28a745';
                setupTrainingCalculator(); // Re-render with inputs
            } else {
                // Saving changes
                const timeInputs = document.querySelectorAll('.training-time-input');
                const newTimes = Array.from(timeInputs).map(input => input.value.trim());
                
                // Basic validation
                if (newTimes.some(t => !/^\d{1,2}:\d{2}$/.test(t))) {
                    alert('Invalid time format. Please use HH:MM.');
                    isEditingTrainingTimes = true; // Stay in edit mode
                    return;
                }
                localStorage.setItem('trainingTimes', JSON.stringify(newTimes));
                
                btn.textContent = 'Edit Times';
                btn.style.backgroundColor = '#17a2b8';
                
                // Important: Clear old bonuses as the keys (times) have changed
                localStorage.removeItem('trainingBonuses'); 
                
                setupTrainingCalculator(); // Re-render with new times
                updateTrainingSummary(); // Recalculate summary
                alert('Training times updated. All training bonuses have been reset.');
            }
        }
        
        function renderTalentChart(improvementData) {
            const ctx = document.getElementById('talent-chart').getContext('2d');
            
            if (talentChart) {
                talentChart.destroy();
            }

            const chartData = improvementData.map(item => {
                const p = item.player;
                // Scale radius based on minutes. Add a base size so players with 0 minutes are still visible.
                const radius = 5 + ((p.totalMinutes || 0) / 100); 
                return {
                    x: p.age,
                    y: item.improvement,
                    r: Math.min(radius, 30), // Cap radius to prevent huge bubbles
                    label: p.name
                };
            });
            
            talentChart = new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Players',
                        data: chartData,
                        backgroundColor: 'rgba(0, 123, 255, 0.6)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const dataPoint = context.raw;
                                    const player = improvementData.find(item => item.player.name === dataPoint.label).player;
                                    return `${dataPoint.label}: Age ${dataPoint.x}, Improvement ${dataPoint.y}%, Minutes ${player.totalMinutes || 0}`;
                                }
                            }
                        },
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Age'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Quality Improvement (%)'
                            }
                        }
                    }
                }
            });
}
        function getCurrentDay() {
            let lastDay = 0;
            players.forEach(p => {
                if (p.progress) {
                    for (let i = p.progress.length - 1; i >= 0; i--) {
                        if (p.progress[i] !== null && p.progress[i] !== undefined) {
                            lastDay = Math.max(lastDay, i);
                        }
                    }
                }
            });
            return lastDay + 1; // Return day number (1-28), not index
        }
        
        function getAdjustedGaScore(p) {
            const totalGoals = (p.leagueGoals || 0) + (p.clGoals || 0) + (p.cupGoals || 0);
            const totalAssists = (p.leagueAssists || 0) + (p.clAssists || 0) + (p.cupAssists || 0);
            let goalWeight = 0, assistWeight = 0;
            const pos = p.positions[0];
            if (['ST', 'AML', 'AMR', 'AMC'].includes(pos)) {
                goalWeight = 1.1; assistWeight = 0.8;
            } else if (['MC', 'ML', 'MR', 'DMC'].includes(pos)) {
                goalWeight = 1.8; assistWeight = 1.5;
            } else if (['DL', 'DR', 'DC', 'GK'].includes(pos)) { // GK included here
                goalWeight = 2.7; assistWeight = 2.3;
            }
            return (totalGoals * goalWeight) + (totalAssists * assistWeight);
        }
        function getAgeValue(age) {
            if (age >= 18 && age <= 21) return 5;
            if (age >= 22 && age <= 25) return 3;
            if (age >= 26) return 2;
            return 0; // For players under 18
        }
        function calculatePowerData() {
            return players.map(p => {
                let currentQuality = p.initialQuality;
                for (let i = p.progress.length - 1; i >= 0; i--) {
                    if (p.progress[i] !== null && p.progress[i] !== undefined) {
                        currentQuality = p.progress[i];
                        break;
                    }
                }
                const improvement = currentQuality - p.initialQuality;
                
                // New Quality Score based on cubic polynomial
                const x = currentQuality;
                const qualityScore = (0.000175825 * x * x * x) - (0.05092985 * x * x) + (4.9956096 * x) - 156.471597;
                // New Improvement Score based on the map
                const improvementMap = { 1:0, 2:0, 3:0, 4:0, 5:1, 6:1, 7:2, 8:2, 9:2, 10:2, 11:3, 12:3, 13:4, 14:5, 15:5, 16:6, 17:7, 18:8, 19:8, 20:9, 21:9, 22:9, 23:10, 24:10, 25:10, 26:11, 27:13, 28:15, 29:17, 30:20 };
                let improvementScore = 0;
                if (improvement > 0) {
                    improvementScore = improvementMap[Math.min(30, improvement)] || 0;
                    if(improvement > 30) improvementScore = 20; // Cap at 20 points
                }
                const totalGoals = (p.leagueGoals || 0) + (p.clGoals || 0) + (p.cupGoals || 0);
                const totalAssists = (p.leagueAssists || 0) + (p.clAssists || 0) + (p.cupAssists || 0);
                const ga = totalGoals + totalAssists;
                const gaPer90 = p.totalMinutes > 0 ? (ga * 90) / p.totalMinutes : 0;
                const usageScore = gaPer90 * 3;
                const gaScore = getAdjustedGaScore(p);
                const ageValue = getAgeValue(p.age);
                
                // Final Power Score Calculation
                const powerScore = qualityScore + improvementScore + gaScore + usageScore + ageValue;
                
                return {
                    player: p,
                    powerScore: powerScore,
                    currentQuality: qualityScore, // This is the Quality Score component
                    improvementScore,
                    adjustedGaPer90: gaScore, // Renamed for clarity in the table
                    usageScore,
                    ageValue
                };
            }).sort((a, b) => b.powerScore - a.powerScore); // Always sort by score descending
        }
        function renderPowerRankingTable(powerData) {
            const tbody = document.querySelector('#power-ranking-table tbody');
            tbody.innerHTML = '';
            const previousDataMap = new Map(previousPowerRanking.map(p => [p.player.id, p]));
            const maxScores = {
                powerScore: Math.max(0, ...powerData.map(d => d.powerScore)),
                currentQuality: Math.max(0, ...powerData.map(d => d.currentQuality)),
                improvementScore: Math.max(0, ...powerData.map(d => d.improvementScore)),
                adjustedGaPer90: Math.max(0, ...powerData.map(d => d.adjustedGaPer90)),
                usageScore: Math.max(0, ...powerData.map(d => d.usageScore)),
                ageValue: Math.max(0, ...powerData.map(d => d.ageValue))
            };
            powerData.forEach((data, index) => {
                const p = data.player;
                const row = document.createElement('tr');
                row.dataset.playerId = p.id;
                if (selectedPowerRankingPlayers.includes(p.id)) {
                    row.classList.add('selected');
                }
                const maxClass = (field, value) => (value > 0 && value === maxScores[field]) ? 'class="top-score"' : '';
                
                // Rank change
                const newRank = index + 1;
                const oldData = previousDataMap.get(p.id);
                const oldRank = oldData ? previousPowerRanking.findIndex(pr => pr.player.id === p.id) + 1 : null;
                let rankChangeHtml = '<span style="color: #999;">–</span>';
                if (oldRank && oldRank !== newRank) {
                    rankChangeHtml = newRank < oldRank
                        ? `<span style="color: green;">▲ ${oldRank - newRank}</span>`
                        : `<span style="color: red;">▼ ${newRank - oldRank}</span>`;
                }
                // Function to create score change HTML
                const getChangeHtml = (field) => {
                    if (!oldData) return '';
                    const diff = data[field] - oldData[field];
                    if (Math.abs(diff) < 0.01) return ''; // Ignore tiny changes
                    const color = diff > 0 ? 'green' : 'red';
                    const sign = diff > 0 ? '+' : '';
                    return ` <span style="font-size: 11px; color: ${color};">(${sign}${diff.toFixed(2)})</span>`;
                };
                const powerScoreChange = getChangeHtml('powerScore');
                const gaScoreChange = getChangeHtml('adjustedGaPer90');
                const usageScoreChange = getChangeHtml('usageScore');
                
                row.innerHTML = `
                    <td>${newRank}</td>
                    <td>${p.name}</td>
                    <td class='${getPositionCategory(p.positions[0])}'>${p.positions.join('/')}</td>
                    <td>${rankChangeHtml}</td>
                    <td ${maxClass('powerScore', data.powerScore)}>${data.powerScore.toFixed(2)}${powerScoreChange}</td>
                    <td ${maxClass('currentQuality', data.currentQuality)}>${data.currentQuality.toFixed(2)}</td>
                    <td ${maxClass('improvementScore', data.improvementScore)}>${data.improvementScore}</td>
                    <td ${maxClass('adjustedGaPer90', data.adjustedGaPer90)}>${data.adjustedGaPer90.toFixed(2)}${gaScoreChange}</td>
                    <td ${maxClass('usageScore', data.usageScore)}>${data.usageScore.toFixed(2)}${usageScoreChange}</td>
                    <td ${maxClass('ageValue', data.ageValue)}>+${data.ageValue}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateAndSavePowerRanking() {
            const currentDay = getCurrentDay();
            const newPowerData = calculatePowerData();
            
            // Update time series data
            powerRankingTimeSeries[currentDay] = newPowerData.map((data) => ({
                playerId: data.player.id,
                powerScore: data.powerScore
            }));
            localStorage.setItem('powerRankingTimeSeries', JSON.stringify(powerRankingTimeSeries));
            
            // Render table and chart
            renderPowerRankingTable(newPowerData);
            renderPowerRankingChart();
            
            // Save the *new* ranking as the "previous" for the next update
            previousPowerRanking = [...newPowerData];
            localStorage.setItem('powerRankingHistory', JSON.stringify(previousPowerRanking));
            
            alert(`Power Ranking updated for Day ${currentDay}!`);
        }
        
        function renderPowerRankingChart() {
            const ctx = document.getElementById('power-ranking-chart').getContext('2d');
            if (powerRankingChart) {
                powerRankingChart.destroy();
            }
            const days = Object.keys(powerRankingTimeSeries).map(Number).sort((a, b) => a - b);
            if (days.length === 0) {
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // Clear if no data
                 return;
            }
            // Consistent colors for each player
            const playerColors = {};
            players.forEach((p, i) => {
                const hue = (i * 137.508) % 360; // Golden angle for distinct colors
                playerColors[p.id] = `hsl(${hue}, 70%, 50%)`;
            });
            const datasets = players.map(player => {
                const data = days.map(day => {
                    const dayData = powerRankingTimeSeries[day];
                    const playerData = dayData.find(d => d.playerId === player.id);
                    return playerData ? { x: day, y: playerData.powerScore } : null;
                }).filter(Boolean); // Remove nulls where player wasn't ranked
                const isSelected = selectedPowerRankingPlayers.includes(player.id);
                const isAnySelected = selectedPowerRankingPlayers.length > 0;
                return {
                    label: player.name,
                    data: data,
                    borderColor: playerColors[player.id] || '#ccc',
                    backgroundColor: playerColors[player.id] || '#ccc',
                    fill: false,
                    tension: 0.1,
                    borderWidth: isSelected ? 4 : (isAnySelected ? 1 : 2),
                    pointRadius: isSelected ? 5 : (isAnySelected ? 2 : 3),
                    pointHoverRadius: 7,
                    borderColor: isAnySelected && !isSelected ? 'rgba(204, 204, 204, 0.5)' : (playerColors[player.id] || '#ccc'),
                };
            }).filter(d => d.data.length > 0); // Only include players with data
            powerRankingChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: { display: true, text: 'Power Score Ranking' },
                            reverse: false,
                            beginAtZero: true
                        },
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Day of Season' },
                            min: 1,
                            max: 28,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: (tooltipItems) => `Day ${tooltipItems[0].raw.x}`,
                                label: (context) => `${context.dataset.label}: Score ${context.raw.y.toFixed(2)}`
                            }
                        },
                         legend: {
                            display: false // Hide legend to avoid clutter; tooltips are better
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'xy',
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                    modifierKey: 'ctrl',
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'xy',
                            }
                        }
                    }
                }
            });
        }
        
        function loadPowerRankingData() {
            previousPowerRanking = JSON.parse(localStorage.getItem('powerRankingHistory') || '[]');
            powerRankingTimeSeries = JSON.parse(localStorage.getItem('powerRankingTimeSeries') || '{}');
            renderPowerRankingTable(previousPowerRanking);
            renderPowerRankingChart();
        }
/* Events */
        addPlayerBtn.addEventListener('click',()=>{clearModal();playerModal.style.display='flex';});
        cancelBtn.addEventListener('click',()=>{playerModal.style.display='none';clearModal();});
        confirmCancelBtn.addEventListener('click',()=>{confirmModal.style.display='none';});
        ageAllBtn.addEventListener('click',ageAllPlayers);
        fullMatchBtn.addEventListener('click',()=>{minutesInput.value='90';});
        confirmMinutesBtn.addEventListener('click',()=>{const mins=parseInt(minutesInput.value);if(isNaN(mins)||mins<1||mins>120){alert('Please enter valid minutes (1-90)');return;}if(selectedPlayersForMinutes.length===0){alert('Please select at least one player');return;}addMinutesToSelected(mins);minutesInput.value='';});
        undoMinutesBtn.addEventListener('click',undoLastMinutesChange);
        undoGaBtn.addEventListener('click',undoLastGaChange);
        resetTrainingBtn.addEventListener('click', resetTrainingCalculator);
        document.getElementById('edit-training-times-btn').addEventListener('click', handleEditSaveTrainingTimes);
        document.getElementById('update-power-ranking-btn').addEventListener('click', updateAndSavePowerRanking);
        endSeasonBtn.addEventListener('click', endSeason);
        downloadDataBtn.addEventListener('click', downloadData);
        uploadDataBtn.addEventListener('click', () => uploadFileInput.click());
        uploadFileInput.addEventListener('change', uploadData);
        
document.getElementById('most-improved-table').addEventListener('click', function(e) {
const header = e.target.closest('th');
            if (header) {
                const sortBy = header.dataset.sort;
                if (!sortBy) return;
                const currentSort = header.dataset.order || 'desc';
                const newOrder = currentSort === 'desc' ? 'asc' : 'desc';
                
                // Remove indicators from other headers
                document.querySelectorAll('#most-improved-table th[data-sort]').forEach(th => {
    if (!th.querySelector('.sort-indicator')) {
        const indicator = document.createElement('span');
        indicator.className = 'sort-indicator';
        indicator.textContent = '▼';
        th.appendChild(indicator);
    }
});

                // Set new order on current header
                header.dataset.order = newOrder;
                header.querySelector('.sort-indicator').classList.add(newOrder);
                updateMostImprovedTable(sortBy, newOrder);
            }
        });
        // Removed the event listener for sorting the power ranking table by clicking headers.
        document.getElementById('power-ranking-table').addEventListener('click', function(e) {
            const row = e.target.closest('tr');
            if (!row || !row.dataset.playerId) return;
            const playerId = parseInt(row.dataset.playerId);
            const isCtrlPressed = e.ctrlKey || e.metaKey;
            if (!isCtrlPressed) {
                // Single selection logic
                if (selectedPowerRankingPlayers.length === 1 && selectedPowerRankingPlayers[0] === playerId) {
                    selectedPowerRankingPlayers = []; // Deselect if clicking the only selected player
                } else {
                    selectedPowerRankingPlayers = [playerId]; // Select only this player
                }
            } else {
                // Multi-selection logic (CTRL/CMD key held)
                const index = selectedPowerRankingPlayers.indexOf(playerId);
                if (index > -1) {
                    selectedPowerRankingPlayers.splice(index, 1); // Deselect
                } else {
                    selectedPowerRankingPlayers.push(playerId); // Select
                }
            }
            renderPowerRankingTable(previousPowerRanking);
            renderPowerRankingChart();
        });
        document.getElementById('minutes-table').addEventListener('click',function(e){
            if(e.target.classList.contains('reset-player-minutes-btn')){
                const playerId=parseInt(e.target.dataset.playerId);
                const player=players.find(p=>p.id===playerId);
                if(player && confirm(`Are you sure you want to reset all minutes for ${player.name}?`)){
                    player.minutes=Array(28).fill(0);
                    player.totalMinutes=0;
                    player.matchesPlayed=0;
                    savePlayersToLocalStorage();
                    updateMinutesTable();
                }
            }
        });
        saveBtn.addEventListener('click',()=>{const name=document.getElementById('player-name').value.trim();const positions=Array.from(document.getElementById('player-position').selectedOptions).map(o=>o.value);const age=parseInt(document.getElementById('player-age').value);const quality=parseInt(document.getElementById('player-quality').value);if(!name||positions.length===0||positions.length>3||!age||!quality){alert('Fill all fields (max 3 positions)');return;}if(currentPlayerId){const player=players.find(p=>p.id===currentPlayerId);if(player){player.name=name;player.positions=positions;player.position=positions[0];player.age=age;player.quality=quality;player.initialQuality=quality;}}else{addPlayer(name,positions,age,quality);}savePlayersToLocalStorage();playerModal.style.display='none';clearModal();renderPlayers();});
        /* Init */
        loadPlayersFromLocalStorage();
        loadArchivedPlayersFromStorage();
        // Load and render previous power ranking from storage on startup
        loadPowerRankingData();
        
        renderPlayers();
        setupTrainingCalculator();
        setupPlayerSearch();
        loadAndRenderArchives();
        // No longer adding sort indicators to power ranking table headers
        // Chart zoom buttons
        document.getElementById('zoom-in-btn').addEventListener('click', () => {
            if (powerRankingChart) powerRankingChart.zoom(1.1);
        });
        document.getElementById('zoom-out-btn').addEventListener('click', () => {
            if (powerRankingChart) powerRankingChart.zoom(0.9);
        });
        document.getElementById('reset-zoom-btn').addEventListener('click', () => {
            if (powerRankingChart) powerRankingChart.resetZoom();
        });
        
        const archivedTable = document.getElementById('archived-players-table');
        if (archivedTable) {
            archivedTable.addEventListener('click', function(e) {
                const header = e.target.closest('th[data-sort]');
                if (!header) return;

                const sortBy = header.dataset.sort;
                const currentOrder = header.dataset.order || 'asc'; // Default to 'asc'
                const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';

                // Update global state
                archivedSortBy = sortBy;
                archivedSortOrder = newOrder;

                // Call render which will handle sorting and indicator updates
                renderArchivedPlayers();
            });
        }
        renderArchivedPlayers();
        // --- EVENT LISTENERS FOR NEW FILTERS ---
        document.getElementById('archive-filters').addEventListener('input', () => {
            renderArchivedPlayers();
        });
        document.getElementById('reset-archive-filters-btn').addEventListener('click', () => {
            document.getElementById('archive-position-filter').value = 'all';
            document.getElementById('archive-age-filter-min').value = '';
            document.getElementById('archive-age-filter-max').value = '';
            document.getElementById('archive-minutes-filter-min').value = '';
            document.getElementById('archive-minutes-filter-max').value = '';
            document.getElementById('archive-matches-filter-min').value = '';
            document.getElementById('archive-matches-filter-max').value = '';
            document.getElementById('archive-goals-filter-min').value = '';
            document.getElementById('archive-goals-filter-max').value = '';
            document.getElementById('archive-assists-filter-min').value = '';
            document.getElementById('archive-assists-filter-max').value = '';
            renderArchivedPlayers();
        });
        document.getElementById('hof-sidebar').addEventListener('click', function(e) {
            if (e.target.classList.contains('hof-category-btn')) {
                const category = e.target.dataset.category;
                renderHallOfFame(category);
            }
        });
        // Sort option change listener
        document.getElementById('sort-option').addEventListener('change', function() {
            renderPlayers();
        });
        
        // Archived Power Ranking Modal close button
        document.getElementById('archived-pr-close').addEventListener('click', () => {
            document.getElementById('archived-pr-modal').style.display = 'none';
        });
        
        // Close modal when clicking outside
        document.getElementById('archived-pr-modal').addEventListener('click', (e) => {
            if (e.target.id === 'archived-pr-modal') {
                document.getElementById('archived-pr-modal').style.display = 'none';
            }
        });
        
        // Stats Calculator functionality
        function initStatsCalculator() {
            const calcPanel = document.getElementById('stats-calculator');
            const calcToggle = document.getElementById('calc-toggle');
            const calcTableBody = document.getElementById('calc-table-body');
            const calcResetBtn = document.getElementById('calc-reset-btn');
            
            // Generate 8 rows for input
            for (let i = 0; i < 8; i++) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="number" class="stats-calc-input calc-minutes" placeholder="0"></td>
                    <td><input type="number" class="stats-calc-input calc-matches" placeholder="0"></td>
                    <td><input type="number" class="stats-calc-input calc-goals" placeholder="0"></td>
                    <td><input type="number" class="stats-calc-input calc-assists" placeholder="0"></td>
                `;
                calcTableBody.appendChild(row);
            }
            
            // Toggle panel open/close
            calcToggle.addEventListener('click', () => {
                calcPanel.classList.toggle('open');
            });
            
            // Calculate sums on input
            calcTableBody.addEventListener('input', updateCalcSums);
            
            function updateCalcSums() {
                const minutesInputs = document.querySelectorAll('.calc-minutes');
                const matchesInputs = document.querySelectorAll('.calc-matches');
                const goalsInputs = document.querySelectorAll('.calc-goals');
                const assistsInputs = document.querySelectorAll('.calc-assists');
                
                let sumMinutes = 0, sumMatches = 0, sumGoals = 0, sumAssists = 0;
                
                minutesInputs.forEach(input => sumMinutes += parseInt(input.value) || 0);
                matchesInputs.forEach(input => sumMatches += parseInt(input.value) || 0);
                goalsInputs.forEach(input => sumGoals += parseInt(input.value) || 0);
                assistsInputs.forEach(input => sumAssists += parseInt(input.value) || 0);
                
                document.getElementById('calc-sum-minutes').textContent = sumMinutes;
                document.getElementById('calc-sum-matches').textContent = sumMatches;
                document.getElementById('calc-sum-goals').textContent = sumGoals;
                document.getElementById('calc-sum-assists').textContent = sumAssists;
            }
            
            // Reset all inputs
            calcResetBtn.addEventListener('click', () => {
                document.querySelectorAll('.stats-calc-input').forEach(input => input.value = '');
                updateCalcSums();
            });
        }
        
        initStatsCalculator();
    });
    function formatSeasonString(seasonSet) {
        if (!seasonSet || seasonSet.size === 0) return 'N/A';
        const seasons = Array.from(seasonSet).sort((a, b) => a - b);
        if (seasons.length === 0) return 'N/A';
        const ranges = [];
        let start = seasons[0];
        let end = seasons[0];
        for (let i = 1; i < seasons.length; i++) {
            if (seasons[i] === end + 1) {
                end = seasons[i];
            } else {
                ranges.push(start === end ? `${start}` : `${start}-${end}`);
                start = seasons[i];
                end = seasons[i];
            }
        }
        ranges.push(start === end ? `${start}` : `${start}-${end}`);
        return ranges.join(', ');
    }
    function renderPlayerSearchResults(results, container) {
        container.innerHTML = '';
        if (results.length === 0) {
            container.innerHTML = '<p style="font-size: 13px; color: #666;">No matching players found in archives.</p>';
            return;
        }
        results.forEach(data => {
            const p = data.player;
            const card = document.createElement('div');
            card.style.cssText = 'background-color: #fff; border: 1px solid #e9e9e9; border-radius: 5px; padding: 15px; margin-bottom: 10px; font-size: 13px;';
            const seasonsString = formatSeasonString(data.seasons);
            card.innerHTML = `
                <h5 style="margin: 0 0 10px 0; font-size: 14px;">
                    ${p.name} (${p.age}, ${p.positions.join('/')})
                </h5>
                <p style="margin: 5px 0;"><strong>Seasons Archived:</strong> ${seasonsString}</p>
                <p style="margin: 5px 0;"><strong>Career Totals:</strong></p>
                <ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
                    <li><strong>Minutes:</strong> ${data.totalMinutes}</li>
                    <li><strong>Matches:</strong> ${data.totalMatches}</li>
                    <li><strong>Goals:</strong> ${data.totalGoals}</li>
                    <li><strong>Assists:</strong> ${data.totalAssists}</li>
                </ul>
            `;
            container.appendChild(card);
        });
    }
    function setupPlayerSearch() {
        const searchInput = document.getElementById('player-search-input');
        const searchResults = document.getElementById('player-search-results');
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.trim().toLowerCase();
            if (query.length < 2) {
                searchResults.innerHTML = '';
                return;
            }
            const seasonArchives = JSON.parse(localStorage.getItem('topElevenArchives') || '[]');
            const individualArchives = JSON.parse(localStorage.getItem('archivedPlayers') || '[]');
            const playerHistory = new Map();
            seasonArchives.forEach(season => {
                season.players.forEach(p => {
                    if (p.name.toLowerCase().includes(query)) {
                        if (!playerHistory.has(p.name)) {
                            playerHistory.set(p.name, { player: p, seasons: new Set(), totalMinutes: 0, totalMatches: 0, totalGoals: 0, totalAssists: 0 });
                        }
                        const history = playerHistory.get(p.name);
                        history.seasons.add(season.seasonNumber);
                        history.totalMinutes += p.totalMinutes || 0;
                        history.totalMatches += p.matchesPlayed || 0;
                        history.totalGoals += (p.leagueGoals || 0) + (p.clGoals || 0) + (p.cupGoals || 0);
                        history.totalAssists += (p.leagueAssists || 0) + (p.clAssists || 0) + (p.cupAssists || 0);
                    }
                });
            });
            individualArchives.forEach(p => {
                if (p.name.toLowerCase().includes(query) && !playerHistory.has(p.name)) {
                    playerHistory.set(p.name, { player: p, seasons: new Set(), totalMinutes: p.totalMinutes || 0, totalMatches: p.matchesPlayed || 0, totalGoals: (p.leagueGoals || 0) + (p.clGoals || 0) + (p.cupGoals || 0), totalAssists: (p.leagueAssists || 0) + (p.clAssists || 0) + (p.cupAssists || 0) });
                }
            });
            renderPlayerSearchResults(Array.from(playerHistory.values()), searchResults);
        });
    }
    function renderHallOfFame(category = 'matchesPlayed') {
        document.querySelectorAll('.hof-category-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector(`.hof-category-btn[data-category="${category}"]`);
        const categoryNames = { 'matchesPlayed': 'Matches Played', 'totalMinutes': 'Total Minutes', 'goals': 'Total Goals', 'assists': 'Total Assists', 'gaPer90': 'G+A per 90' };
        if (activeBtn) {
            activeBtn.classList.add('active');
            const categoryName = categoryNames[category] || activeBtn.textContent;
            document.getElementById('hof-title').textContent = `Hall of Fame: Top 10 by ${categoryName}`;
            document.getElementById('hof-value-header').textContent = categoryName;
        }
        const tbody = document.querySelector('#hof-table tbody');
        tbody.innerHTML = '';
        const seasonArchives = JSON.parse(localStorage.getItem('topElevenArchives') || '[]');
        const manuallyArchivedPlayers = JSON.parse(localStorage.getItem('archivedPlayers') || '[]');
        if (manuallyArchivedPlayers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6">No archived players found to build the Hall of Fame.</td></tr>';
            return;
        }
        // Use stats directly from archived player records, respecting any manual edits.
        const aggregatedPlayers = manuallyArchivedPlayers.map(p => {
            const careerMatches = p.matchesPlayed || 0;
            const careerMinutes = p.totalMinutes || 0;
            const careerGoals = (p.leagueGoals || 0) + (p.clGoals || 0) + (p.cupGoals || 0);
            const careerAssists = (p.leagueAssists || 0) + (p.clAssists || 0) + (p.cupAssists || 0);
            const ga = careerGoals + careerAssists;
            const gaPer90 = careerMinutes > 0 ? (ga * 90) / careerMinutes : 0;
            // Find all seasons this player participated in.
            const seasons = new Set();
            // Add the season they were manually archived in (for new data)
            if (p.archivedInSeason) {
                seasons.add(p.archivedInSeason);
            }
            // Add seasons from full season-end archives
            seasonArchives.forEach(season => {
                if (season.players.some(seasonPlayer => seasonPlayer.name === p.name)) {
                    seasons.add(season.seasonNumber);
                }
            });
            return {
                player: p,
                matchesPlayed: careerMatches,
                totalMinutes: careerMinutes,
                goals: careerGoals,
                assists: careerAssists,
                gaPer90: gaPer90,
                seasons: seasons
            };
        });
        aggregatedPlayers.sort((a, b) => b[category] - a[category]);
        const top10 = aggregatedPlayers.slice(0, 10);
        if (top10.length === 0) {
             tbody.innerHTML = '<tr><td colspan="6">No archived players found to build the Hall of Fame.</td></tr>';
             return;
        }
        top10.forEach((item, index) => {
            const row = document.createElement('tr');
            const p = item.player;
            let value;
            switch (category) {
                case 'gaPer90': value = item[category].toFixed(2); break;
                default: value = item[category];
            }
            row.innerHTML = `
                <td class="rank">${index + 1}</td>
                <td>${p.name}</td>
                <td>${p.positions.join('/')}</td>
                <td>${p.age}</td>
                <td>${formatSeasonString(item.seasons)}</td>
                <td class="value">${value}</td>
            `;
            tbody.appendChild(row);
        });
    }
    
    function showArchivedPowerRanking(archive) {
        const modal = document.getElementById('archived-pr-modal');
        const title = document.getElementById('archived-pr-title');
        const body = document.getElementById('archived-pr-body');
        
        title.textContent = `Season ${archive.seasonNumber} Power Rankings (Ended: ${archive.endDate})`;
        body.innerHTML = '';
        
        // Check if power ranking data exists
        if (!archive.powerRankingHistory || archive.powerRankingHistory.length === 0) {
            body.innerHTML = '<p style="color: #666;">No power ranking data available for this season.</p>';
            modal.style.display = 'flex';
            return;
        }
        
        // Create table container
        const tableContainer = document.createElement('div');
        tableContainer.className = 'table-container';
        tableContainer.style.marginBottom = '30px';
        
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.innerHTML = `
            <thead>
                <tr>
                    <th style="border: 1px solid #ddd; padding: 8px;">Rank</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Player</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Positions</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Power Score</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Quality</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Improvement</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">G+A Score</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Usage</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Age Bonus</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;
        
        const tbody = table.querySelector('tbody');
        archive.powerRankingHistory.forEach((data, index) => {
            const p = data.player;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="border: 1px solid #ddd; padding: 8px;">${index + 1}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${p.name}</td>
                <td style="border: 1px solid #ddd; padding: 8px;" class="${getPositionCategory(p.positions[0])}">${p.positions.join('/')}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${data.powerScore.toFixed(2)}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${data.currentQuality.toFixed(2)}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${data.improvementScore}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${data.adjustedGaPer90.toFixed(2)}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">${data.usageScore.toFixed(2)}</td>
                <td style="border: 1px solid #ddd; padding: 8px;">+${data.ageValue}</td>
            `;
            tbody.appendChild(row);
        });
        
        tableContainer.appendChild(table);
        body.appendChild(tableContainer);
        
        // Create chart if time series data exists
        if (archive.powerRankingTimeSeries && Object.keys(archive.powerRankingTimeSeries).length > 0) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.style.height = '400px';
            chartContainer.innerHTML = '<h3>Power Ranking History</h3><canvas id="archived-pr-chart"></canvas>';
            body.appendChild(chartContainer);
            
            // Render chart after modal is visible
            setTimeout(() => {
                renderArchivedPowerRankingChart(archive.powerRankingTimeSeries, archive.players);
            }, 100);
        }
        
        modal.style.display = 'flex';
    }
    
    function renderArchivedPowerRankingChart(timeSeries, archivedPlayers) {
        const ctx = document.getElementById('archived-pr-chart');
        if (!ctx) return;
        
        const days = Object.keys(timeSeries).map(Number).sort((a, b) => a - b);
        if (days.length === 0) return;
        
        // Generate consistent colors for players
        const playerColors = {};
        archivedPlayers.forEach((p, i) => {
            const hue = (i * 137.508) % 360;
            playerColors[p.id] = `hsl(${hue}, 70%, 50%)`;
        });
        
        const datasets = archivedPlayers.map(player => {
            const data = days.map(day => {
                const dayData = timeSeries[day];
                const playerData = dayData.find(d => d.playerId === player.id);
                return playerData ? { x: day, y: playerData.powerScore } : null;
            }).filter(Boolean);
            
            return {
                label: player.name,
                data: data,
                borderColor: playerColors[player.id] || '#ccc',
                backgroundColor: playerColors[player.id] || '#ccc',
                fill: false,
                tension: 0.1,
                borderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 6
            };
        }).filter(d => d.data.length > 0);
        
        new Chart(ctx, {
            type: 'line',
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        title: { display: true, text: 'Power Score' },
                        beginAtZero: true
                    },
                    x: {
                        type: 'linear',
                        title: { display: true, text: 'Day of Season' },
                        min: 1,
                        max: 28,
                        ticks: { stepSize: 1 }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: (tooltipItems) => `Day ${tooltipItems[0].raw.x}`,
                            label: (context) => `${context.dataset.label}: Score ${context.raw.y.toFixed(2)}`
                        }
                    },
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
</script>
</body>
</html>
